<!DOCTYPE html>

<!-- ============================================================
üîí CRITICAL ‚Äî –ù–ï –¢–†–û–ì–ê–¢–¨ (–ü–ê–ü–ê–ñ–ö–•) | Date: 2026-02-07
Doc: docs/LOGIC_SPEC_v1.5.3.md
–≠—Ç–∞–ª–æ–Ω: jkh_site_full_v01.27.3.zip | SHA256: 6b4254a9b3b74327fe2d2c48c34e3e446ba9ae4e3369c6c554a683bde7b6ceec

- ES-modules (type="module") –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ v1.5.x (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å file://)
- –ü–æ—Ä—è–¥–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π CRITICAL: calc_engine.js –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–û payment_table.js / spravka_sud.js
- –ö–∞—Ä—Ç–æ—á–∫–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞ = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã; —Å–ø—Ä–∞–≤–∫–∏/–æ—Ç—á—ë—Ç—ã –Ω–µ –ª–æ–º–∞—é—Ç –∫–∞—Ä—Ç–æ—á–∫—É
============================================================ -->

<html lang="ru">
<head>
    <meta charset="UTF-8">
    <script src="auth.js"></script>
    <script src="storage.js"></script>
    <script src="critical_guard.js" defer></script>
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞</title>
    <link rel="stylesheet" href="style.css">

    <script src="constants.js"></script>
    <script src="data.js"></script>
    <script src="layout.js"></script>

    <!-- üî¥ CRITICAL: –¥–≤–∏–∂–æ–∫ –∞–≤—Ç–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏–π -->
    <script src="autoaccrual_engine.js"></script>

    <!-- —Ç–∞–±–ª–∏—Ü–∞ –æ–ø–ª–∞—Ç / –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π -->
    <script src="calc_engine.js"></script>
    <script src="payment_table.js"></script>

    <style>
        .uid-click{ cursor:pointer; text-decoration: underline; }

        .edit-link {
            font-size: 13px;
            margin-left: 14px;
            cursor: pointer;
            text-decoration: underline;
            font-weight: normal;
        }

        #abonentEditModal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 6000;
        }

        #changeResponsibleModal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 6500;
        }
        .change-resp-card {
            width: 600px;
            background: #fff;
            border: 2px solid #000;
            padding: 18px;
            box-sizing: border-box;
        }
        .change-resp-card label {
            font-size: 13px;
            display: block;
            margin-top: 10px;
        }
        .change-resp-card input,
        .change-resp-card select {
            width: 100%;
            border: 2px solid #000;
            height: 28px;
            padding: 2px 6px;
            box-sizing: border-box;
            font-size: 13px;
        }
        .change-resp-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 16px;
        }
        .change-resp-actions button {
            border: 2px solid #000;
            padding: 8px 10px;
            cursor: pointer;
            background: #fff;
            font-size: 13px;
            white-space: nowrap;
        }

        .change-resp-hint {
            margin-top: 10px;
            border: 2px solid #000;
            padding: 10px;
            background: #f7f7f7;
            font-size: 13px;
            line-height: 1.35;
        }
        .change-resp-hint b { font-weight: 700; }
        .change-resp-hint .row { margin-top: 6px; }

        .abonent-edit-card {
            width: 560px;
            background: #fff;
            border: 2px solid #000;
            padding: 18px 18px 16px 18px;
            box-sizing: border-box;
        }
        .abonent-edit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 12px;
            margin-top: 10px;
        }
        .abonent-edit-grid label {
            font-size: 13px;
        }
        .abonent-edit-grid input,
        .abonent-edit-grid select {
            width: 100%;
            border: 2px solid #000;
            height: 28px;
            padding: 2px 6px;
            box-sizing: border-box;
            font-size: 13px;
        }
        .abonent-edit-grid .full {
            grid-column: 1 / -1;
        }
        .abonent-edit-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 14px;
        }
        .abonent-edit-actions button {
            border: 2px solid #000;
            padding: 8px 12px;
            background: #e5e5e5;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        .readonly-hint {
            font-size: 12px;
            opacity: 0.85;
        }

        /* ===== –í–´–†–ê–í–ù–ò–í–ê–ù–ò–ï –®–ò–†–ò–ù –ö–û–õ–û–ù–û–ö "–û–ë–©–ò–ï –î–ê–ù–ù–´–ï" ===== */
        #abonentInfoTable { width: 100%; table-layout: fixed; }
        #abonentInfoTable th, #abonentInfoTable td{
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== –ö–≤–∞—Ä—Ç–∏—Ä–∞ / –ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å ===== */
        .premise-card {
            margin-top: 10px;
            border: 2px solid #000;
            padding: 12px;
            background: #fff;
        }
        .premise-card .premise-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 8px;
        }
        .premise-card .premise-title {
            font-size: 16px;
            font-weight: 700;
        }
        .premise-card .premise-sub {
            font-size: 12px;
        }
        .premise-card .premise-grid {
            display: grid;
            grid-template-columns: 210px 1fr;
            gap: 6px 12px;
            font-size: 13px;
        }
        .premise-card .premise-grid .k {
            font-weight: 700;
        }
        .premise-card .premise-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-start;
            gap: 10px;
        }
            .transfer-card{
            margin-top: 12px;
            border: 2px solid #000;
            padding: 10px;
            background: #fff7ea;
        }
        .transfer-title{
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .transfer-sub{
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 4px;
        }
        .transfer-row{
            font-size: 13px;
            margin-top: 3px;
        }
        .transfer-item{
            border-top: 1px solid #000;
            padding-top: 6px;
            margin-top: 6px;
            font-size: 13px;
        }
        .transfer-item a{
            text-decoration: underline;
        }
    </style>
</head>
<body>

<script>renderLayout();</script>

<h2>–ö–∞—Ä—Ç–æ—á–∫–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞</h2>

<h3 id="abonentTitle">
    –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    <span class="edit-link" onclick="openAbonentEdit()">–∏–∑–º–µ–Ω–∏—Ç—å</span>
</h3>

<table id="abonentInfoTable">
    <!-- ===== —Ñ–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—ã –ø–æ–¥ 14 –∫–æ–ª–æ–Ω–æ–∫ (—Å —É–ª–∏—Ü–µ–π) ===== -->
    <colgroup>
        <col style="width:7%">  <!-- –ª–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç -->
        <col style="width:9%">  <!-- —Ä–µ–≥. ‚Ññ –∫–≤ -->
        <col style="width:9%">  <!-- –§–∞–º–∏–ª–∏—è -->
        <col style="width:8%">  <!-- –ò–º—è -->
        <col style="width:8%">  <!-- –û—Ç—á–µ—Å—Ç–≤–æ -->
        <col style="width:6%">  <!-- –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å -->
        <col style="width:6%">  <!-- –ø—Ä–∞–≤–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ -->
        <col style="width:6%">  <!-- –∫–æ–ª –∫–æ–º–Ω–∞—Ç -->
        <col style="width:7%">  <!-- –≥–æ—Ä–æ–¥ -->
        <col style="width:10%"> <!-- —É–ª–∏—Ü–∞ -->
        <col style="width:5%">  <!-- –¥–æ–º -->
        <col style="width:4%">  <!-- –∫–≤ -->
        <col style="width:6%">  <!-- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID -->
        <col style="width:9%">  <!-- —Ç–µ–ª–µ—Ñ–æ–Ω -->
    </colgroup>

    <thead>
    <tr>
        <th>–ª–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç</th>
        <th>—Ä–µ–≥. ‚Ññ –∫–≤</th>
        <th>–§–∞–º–∏–ª–∏—è</th>
        <th>–ò–º—è</th>
        <th>–û—Ç—á–µ—Å—Ç–≤–æ</th>
        <th>–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å</th>
        <th>–ø—Ä–∞–≤–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</th>
        <th>–∫–æ–ª –∫–æ–º–Ω–∞—Ç</th>
        <th>–≥–æ—Ä–æ–¥</th>
        <th>—É–ª–∏—Ü–∞</th>
        <th>–¥–æ–º</th>
        <th>–∫–≤</th>
        <th>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID</th>
        <th>—Ç–µ–ª–µ—Ñ–æ–Ω</th>
    </tr>
    </thead>
    <tbody id="abonentInfoBody"></tbody>
</table>

<div class="premise-card" id="premiseCard">
    <div class="premise-head">
        <div>
            <div class="premise-title">–ö–≤–∞—Ä—Ç–∏—Ä–∞ / –ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å</div>
            <div class="premise-sub muted">–î–∞–Ω–Ω—ã–µ –ø–æ –æ–±—ä–µ–∫—Ç—É (–∫–≤–∞—Ä—Ç–∏—Ä–∞) –∏ —Ç–µ–∫—É—â–µ–º—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É</div>
        </div>
    </div>

    <div class="premise-grid">
        <div class="k">–†–µ–≥. ‚Ññ –∫–≤</div><div><span id="premiseRegnum">‚Äî</span></div>
        <div class="k">–ê–¥—Ä–µ—Å</div><div><span id="premiseAddress">‚Äî</span></div>
        <div class="k">–ü–ª–æ—â–∞–¥—å</div><div><span id="premiseSquare">‚Äî</span></div>
        <div class="k">–ö–≤–∞—Ä—Ç–∏—Ä–∞ –∑–∞–≤–µ–¥–µ–Ω–∞</div><div><span id="premiseCreatedAt">‚Äî</span></div>
        <div class="k">–¢–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</div><div><span id="premiseResponsible">‚Äî</span></div>
        <div class="k">–ü–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</div><div><span id="premisePeriod">‚Äî</span></div>
        <div class="k">–ü–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (—ç—Ç–æ—Ç –∞–±–æ–Ω–µ–Ω—Ç)</div><div><span id="premiseMyPeriod">‚Äî</span></div>
    </div>

    <div class="premise-actions">
        <button class="btn" type="button" onclick="openChangeResponsibleModal()">–°–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</button>
        <button class="btn" type="button" onclick="openResponsibilityReport()">–û—Ç—á—ë—Ç: –∫—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</button>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:700; margin-bottom:6px;">–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ</div>
      <table id="respHistoryTable" style="width:100%; border-collapse:collapse; font-size:13px;">
        <thead>
          <tr>
            <th style="border:2px solid #000; padding:6px; width:160px;">–ü–µ—Ä–∏–æ–¥</th>
            <th style="border:2px solid #000; padding:6px; width:90px;">–õ–°</th>
            <th style="border:2px solid #000; padding:6px;">–§–ò–û</th>
            <th style="border:2px solid #000; padding:6px; width:90px;">–°—Ç–∞—Ç—É—Å</th>
            <th style="border:2px solid #000; padding:6px; width:130px;">–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody id="respHistoryBody"></tbody>
      </table>
      <div class="readonly-hint" style="margin-top:6px;">
        üî¥ –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π/–æ–ø–ª–∞—Ç –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (links).
      </div>
    <!-- ===== –ü–µ—Ä–µ–¥–∞—á–∞ –¥–æ–ª–≥–∞/–ø–µ–Ω–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –æ–±–µ–∏—Ö –∫–∞—Ä—Ç–æ—á–∫–∞—Ö) ===== -->
    <div class="transfer-card" id="transferCard" style="display:none;">
      <div class="transfer-title">–ü–µ—Ä–µ–¥–∞—á–∞ –¥–æ–ª–≥–∞ / –ø–µ–Ω–∏</div>

      <div id="transferIncoming" style="display:none;">
        <div class="transfer-sub">–ü–æ–ª—É—á–µ–Ω–æ —ç—Ç–∏–º –∞–±–æ–Ω–µ–Ω—Ç–æ–º</div>
        <div class="transfer-row"><b>–° –¥–∞—Ç—ã:</b> <span id="ti_start" class="mono">‚Äî</span></div>
        <div class="transfer-row"><b>–û—Ç –∞–±–æ–Ω–µ–Ω—Ç–∞:</b> <span id="ti_from">‚Äî</span></div>
        <div class="transfer-row"><b>–î–æ–ª–≥:</b> <span id="ti_principal" class="mono">0.00</span></div>
        <div class="transfer-row"><b>–ü–µ–Ω—è:</b> <span id="ti_penalty" class="mono">0.00</span></div>
        <div class="transfer-row"><b>–†–µ–∂–∏–º:</b> <span id="ti_mode">‚Äî</span></div>
        <div class="transfer-row"><b>–°—Ç–∞—Ç—É—Å:</b> <span id="ti_status">‚Äî</span></div>
      </div>

      <div id="transferFreeze" style="display:none; margin-top:10px;">
        <div class="transfer-sub">–ó–∞–º–æ—Ä–æ–∑–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ (—Å—Ç–∞—Ä—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü)</div>
        <div class="transfer-row"><b>–ü–µ–Ω—è/–∏—Ç–æ–≥–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –¥–æ:</b> <span id="tf_freeze" class="mono">‚Äî</span></div>
      </div>

      <div id="transferOutgoing" style="display:none; margin-top:10px;">
        <div class="transfer-sub">–ü–µ—Ä–µ–¥–∞–Ω–æ —ç—Ç–∏–º –∞–±–æ–Ω–µ–Ω—Ç–æ–º</div>
        <div id="to_list"></div>
      </div>
    </div>

    </div>
</div>

<div class="options">
    <label onclick="location.href='exclude_period.html?abonent=' + encodeURIComponent(getAbonentIdFromURL())"
           style="cursor:pointer; text-decoration:underline;">
        –ò—Å–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–∏–æ–¥ —Ä–∞—Å—á—ë—Ç–∞
    </label>

    <label>
        –ú–æ—Ä–∞—Ç–æ—Ä–∏–π
        <input type="checkbox" id="moratoriumToggle">
    </label>

    <label onclick="openNotesModal()"
           style="cursor:pointer; text-decoration:underline;">
        –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞
    </label>
</div>

<div class="calc-inline">
    <div class="calc-inline-title">
        <b>–†–ê–°–ß–Å–¢ –í–ó–´–°–ö–ò–í–ê–ï–ú–û–ô –°–£–ú–ú–´</b> <span class="calc-inline-sub">–∑–∞ –ø–µ—Ä–∏–æ–¥:</span>
    </div>

    <div class="calc-inline-fields">
        <input id="calcFrom" type="date" value="">
        <input id="calcTo" type="date" value="">
    </div>

    <div class="calc-inline-actions">
        <button class="calc-btn" id="calcRunBtn" type="button">—Ä–∞—Å—á—ë—Ç</button>
        <button class="calc-btn" id="calcReportsBtn" type="button">—Å–ø—Ä–∞–≤–∫–∏</button>
        <button class="calc-btn" id="calcResetBtn" type="button">—Å–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
</div>

<h3>–û–ø–ª–∞—Ç–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞</h3>

<div class="note" style="margin:6px 0 10px 0; font-size:12px; opacity:0.85;">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π; –æ–ø–ª–∞—Ç—ã ‚Äî –Ω–∏–∂–µ. –ï—Å–ª–∏ –≤–∫–ª—é—á–∞–µ—Ç–µ ¬´–∑–∞ –ø–µ—Ä–∏–æ–¥¬ª, –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

<div class="payments-header">
    <button class="btn" onclick="addPaymentRow()">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
    <button class="btn" onclick="openPaymentSourcesModal()" title="–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è">–ò—Å—Ç–æ—á–Ω–∏–∫–∏</button>
</div>

<div>
    <table id="paymentTable" class="payments-table">
        <colgroup>
            <col style="width:12%">
            <col style="width:8%">
            <col style="width:9%">
            <col style="width:11%">
            <col style="width:10%">
            <col style="width:20%">
            <col style="width:8%">
            <col style="width:7%">
            <col style="width:7%">
            <col style="width:14%">
            <col style="width:4%">
        </colgroup>

        <thead>
        <tr>
            <th>–ì–æ–¥/–ú–µ—Å—è—Ü</th>
            <th>–ù–∞—á–∏—Å–ª–µ–Ω–æ</th>
            <th>–û–ø–ª–∞—á–µ–Ω–æ</th>
            <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
            <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
            <th>–û–ø–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</th>
            <th>–ø–æ –æ–±—è–∑.</th>
            <th>–ø–æ –ø–µ–Ω–∏</th>
            <th>–í—Å–µ–≥–æ</th>
            <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
            <th>ID</th>
        </tr>
        </thead>
        <tbody id="paymentTableBody"></tbody>
    </table>
</div>

<div class="bottom-nav">
    <a href="index.html" class="back-btn">‚¨Ö –Ω–∞–∑–∞–¥</a>
</div>

<div id="notesModal"
     style="position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.4);display:none;align-items:center;
            justify-content:center;z-index:5000;">
    <div style="width:450px;background:#fff;border:2px solid #000;padding:20px;">
        <h3>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞</h3>
        <textarea id="notesText"
                  style="width:100%;height:200px;border:2px solid #000;"></textarea>
        <div style="margin-top:15px;display:flex;justify-content:space-between;">
            <button onclick="saveNotes()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeNotesModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- ===== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ ===== -->
<div id="changeResponsibleModal">
    <div class="change-resp-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <h3 style="margin:0;">–°–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</h3>
            <div class="readonly-hint" style="text-align:right;">
                –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥ —É —Ç–µ–∫—É—â–µ–≥–æ<br>–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —É –Ω–æ–≤–æ–≥–æ
            </div>
        </div>

        <div id="cr_info" class="muted" style="margin-top:8px;"></div>

        <div class="change-resp-hint">
            <b>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã:</b>
            <div class="row">‚úÖ <b>–° –¥–æ–ª–≥–æ–º</b> ‚Äî –¥–æ–ª–≥ (–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/–æ–ø–ª–∞—Ç—ã) –æ—Å—Ç–∞—é—Ç—Å—è ¬´–∫–∞–∫ –µ—Å—Ç—å¬ª, –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã.</div>
            <div class="row">‚úÖ <b>–ë–µ–∑ –¥–æ–ª–≥–∞</b> ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–æ–ª–≥ —É —Å—Ç–∞—Ä–æ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞, –∞ —É –Ω–æ–≤–æ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–æ–ª–≥ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å –Ω—É–ª—è <u>—Å –¥–∞—Ç—ã –ø–µ—Ä–µ–¥–∞—á–∏</u>.</div>
            <div class="row" style="margin-top:8px;"><b>–í–∞–∂–Ω–æ:</b> —Å–µ–π—á–∞—Å –º—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ø–µ—Ä–µ–¥–∞—á–∏, –∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî –Ω–∞—É—á–∏—Ç—å —Ä–∞—Å—á—ë—Ç —Ä–µ–∞–ª—å–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å ¬´–æ–±–Ω—É–ª–µ–Ω–∏–µ¬ª –≤ —Ç–∞–±–ª–∏—Ü–µ –æ–ø–ª–∞—Ç.</div>
        </div>

        <label>–ù–æ–≤—ã–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–ª–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç)</label>
        <select id="cr_newAbonent"></select>

        <label>–î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏ / –Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</label>
        <input id="cr_date" type="date">

        <div class="change-resp-actions">
            <button onclick="applyChangeResponsible('WITH_DEBT')">–ü–µ—Ä–µ–¥–∞—Ç—å –° –î–û–õ–ì–û–ú</button>
            <button onclick="applyChangeResponsible('NO_DEBT')">–ü–µ—Ä–µ–¥–∞—Ç—å –ë–ï–ó –î–û–õ–ì–ê</button>
            <button onclick="closeChangeResponsibleModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- ===== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–±–æ–Ω–µ–Ω—Ç–∞ ===== -->
<div id="abonentEditModal">
    <div class="abonent-edit-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <h3 style="margin:0;">–ò–∑–º–µ–Ω–∏—Ç—å –∞–±–æ–Ω–µ–Ω—Ç–∞</h3>
            <div class="readonly-hint">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID, –∞–¥—Ä–µ—Å –∏ —Ä–µ–≥. ‚Ññ –∫–≤ –º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è</div>
        </div>

        <div class="abonent-edit-grid">
            <div>
                <label>–õ–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç</label>
                <input id="ae_ls" type="text" inputmode="numeric">
            </div>
            <div>
                <label>–†–µ–≥. ‚Ññ –∫–≤</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_regnum" type="text" disabled>
            </div>

            <div>
                <label>–§–∞–º–∏–ª–∏—è</label>
                <input id="ae_last" type="text">
            </div>
            <div>
                <label>–ò–º—è</label>
                <input id="ae_first" type="text">
            </div>

            <div class="full">
                <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
                <input id="ae_mid" type="text">
            </div>

            <div>
                <label>–ì–æ—Ä–æ–¥</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_city" type="text" disabled>
            </div>
            <div>
                <label>–£–ª–∏—Ü–∞</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_street" type="text" disabled>
            </div>

            <div>
                <label>–î–æ–º</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_house" type="text" disabled>
            </div>
            <div>
                <label>–ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_flat" type="text" disabled>
            </div>

            <div>
                <label>–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å (–º¬≤)</label>
                <input id="ae_square" type="number" step="0.1">
            </div>
            <div>
                <label>–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç</label>
                <input id="ae_rooms" type="text" placeholder='–Ω–∞–ø—Ä–∏–º–µ—Ä: "–¥–≤—É—Ö –∫–æ–º–Ω–∞—Ç"'>
            </div>

            <div>
                <label>–ü—Ä–∞–≤–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</label>
                <input id="ae_share" type="text" placeholder='–Ω–∞–ø—Ä–∏–º–µ—Ä: "1/1"'>
            </div>
            <div>
                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input id="ae_phone" type="text">
            </div>

            <div class="full">
                <label>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID</label>
                <input id="ae_uid" type="text" disabled>
            </div>
        </div>

        <div class="abonent-edit-actions">
            <button type="button" onclick="saveAbonentEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <button type="button" onclick="closeAbonentEdit()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
function getAbonentIdFromURL() {
    const params = new URLSearchParams(window.location.search || "");
    const uid = String(params.get("uid") || "").trim();
    const fromUrl = String(params.get("abonent") || "").trim();

    // 1) –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –ø–æ uid ‚Äî –Ω–∞–π–¥—ë–º –õ–° (—Ç–µ–∫—É—â–∏–π –∫–ª—é—á) –ø–æ uid
    if (uid) {
        const db = window.AbonentsDB?.abonents || {};
        for (const id of Object.keys(db)) {
            if (String(db[id]?.uid || "").trim() === uid) return id;
        }
    }

    // 2) –∏–Ω–∞—á–µ ‚Äî –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–ø–æ –õ–°)
    if (fromUrl) return fromUrl;

    const db = window.AbonentsDB?.abonents || {};
    const first = Object.keys(db)[0];
    return first || "27";
}

function getDb() {
    if (window.Data && typeof window.Data.getDb === "function") {
        const db = window.Data.getDb();
        return db?.abonents || {};
    }
    return window.AbonentsDB?.abonents || {};
}

function getPremisesDb(){
    if (window.Data && typeof window.Data.getDb === "function") {
        const db = window.Data.getDb();
        return db?.premises || {};
    }
    return window.AbonentsDB?.premises || {};
}

function getLinks(){
    if (window.Data && typeof window.Data.getDb === "function") {
        const db = window.Data.getDb();
        return Array.isArray(db?.links) ? db.links : [];
    }
    return Array.isArray(window.AbonentsDB?.links) ? window.AbonentsDB.links : [];
}

function canWriteOrExplainLocal(){
    try {
        if (window.Data && typeof window.Data.ensureWriteOrExplain === "function") return window.Data.ensureWriteOrExplain();
        return (typeof window.canWriteOrExplain === "function") ? window.canWriteOrExplain() : true;
    } catch (e) {
        return true;
    }
}

function getPremiseForAbonent(abonentId, abonentObj){
    const a = abonentObj || null;
    const regnum = String(a?.premiseRegnum || a?.regnum || "").trim();
    if (!regnum) return { regnum: "", p: null };
    const p = getPremisesDb()[regnum] || null;
    return { regnum, p };
}

function getActiveLinkForAbonent(abonentId, regnum){
    const id = String(abonentId);
    const r = String(regnum || "").trim();
    const links = getLinks().filter(l => String(l?.abonentId) === id && String(l?.regnum || "").trim() === r);
    if (!links.length) return null;
    const active = links.find(l => !String(l?.dateTo || "").trim());
    if (active) return active;
    return links.slice().sort((a,b) => String(b?.dateTo||"").localeCompare(String(a?.dateTo||"")))[0];
}

function getActiveLinkForPremise(regnum){
    const r = String(regnum || '').trim();
    if (!r) return null;
    const links = getLinks().filter(l => String(l?.regnum || '').trim() === r);
    if (!links.length) return null;
    const active = links.find(l => !String(l?.dateTo || '').trim());
    if (active) return active;
    return links.slice().sort((a,b) => String(b?.dateTo||"").localeCompare(String(a?.dateTo||"")))[0];
}

function getCurrentAbonent() {
    const id = String(getAbonentIdFromURL());
    const db = getDb();
    return { id, a: db[id] || null };
}

function splitFio(fio) {
    const parts = String(fio || "").trim().split(/\s+/).filter(Boolean);
    return {
        last: parts[0] || "",
        first: parts[1] || "",
        mid: parts.slice(2).join(" ") || ""
    };
}

function joinFio(last, first, mid) {
    return [last, first, mid].map(x => String(x || "").trim()).filter(Boolean).join(" ");
}

async function copyUidFromCard(){
    const { a } = getCurrentAbonent();
    const uid = String(a?.uid || "").trim();
    if (!uid) return;

    try{
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(uid);
            alert("UID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
            return;
        }
    }catch(e){}

    const ta = document.createElement("textarea");
    ta.value = uid;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand("copy"); alert("UID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"); } catch(e){}
    document.body.removeChild(ta);
}

/* ‚úÖ FIX: fillAbonentCard() ‚Äî —É–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ —Å–∫–æ–±–∫–∏, –ª–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ */
function fillAbonentCard() {
    const { id, a } = getCurrentAbonent();
    if (!a) return;

    const { regnum, p } = getPremiseForAbonent(id, a);
    const premise = p || {};

    const fioParts = splitFio(a.fio);

    document.getElementById("abonentTitle").innerHTML =
        '–û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ&nbsp;&nbsp;' + (a.fio || "") +
        ' <span class="edit-link" onclick="openAbonentEdit()">–∏–∑–º–µ–Ω–∏—Ç—å</span>';

    const tbody = document.getElementById("abonentInfoBody");
    tbody.innerHTML = `
      <tr>
        <td>${id}</td>
        <td>${regnum || a.regnum || ""}</td>
        <td>${fioParts.last}</td>
        <td>${fioParts.first}</td>
        <td>${fioParts.mid}</td>
        <td>${(premise.square ?? a.square) ?? ""}</td>
        <td>${a.share ?? ""}</td>
        <td>${a.rooms ?? ""}</td>
        <td>${premise.city ?? a.city ?? ""}</td>
        <td>${premise.street ?? a.street ?? ""}</td>
        <td>${premise.house ?? a.house ?? ""}</td>
        <td>${premise.flat ?? a.flat ?? ""}</td>
        <td class="uid-click" onclick="copyUidFromCard()" title="–ù–∞–∂–º–∏ ‚Äî —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å UID">${a.uid ?? ""}</td>
        <td>${a.phone ?? ""}</td>
      </tr>
    `;

    // ===== –ó–∞–ø–æ–ª–Ω—è–µ–º –±–ª–æ–∫ "–ö–≤–∞—Ä—Ç–∏—Ä–∞ / –ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å" =====
    const addr = [premise.city ?? a.city, premise.street ?? a.street, premise.house ?? a.house, premise.flat ?? a.flat]
        .map(x => String(x || '').trim()).filter(Boolean).join(', ');

    const setText = (idEl, val) => {
        const el = document.getElementById(idEl);
        if (!el) return;
        const v = String(val || '').trim();
        el.textContent = v ? v : '‚Äî';
    };

    setText('premiseRegnum', regnum || a.regnum || '');
    setText('premiseAddress', addr);
    setText('premiseSquare', (premise.square ?? a.square) ?? '');
    setText('premiseCreatedAt', premise.createdAt || '');

    const activePremiseLink = regnum ? getActiveLinkForPremise(regnum) : null;
    const activeAbId = String(activePremiseLink?.abonentId || '').trim();
    const activeAb = activeAbId ? (getDb()[activeAbId] || null) : null;
    const activeName = String(activeAb?.fio || '').trim();

    // –∫—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ
    if (activeAbId) {
        setText('premiseResponsible', activeName ? `${activeAbId} ‚Äî ${activeName}` : activeAbId);
        const df = String(activePremiseLink?.dateFrom || '').trim();
        const dt = String(activePremiseLink?.dateTo || '').trim();
        const periodHtml = (df || dt)
            ? `${df || '‚Äî'} ‚Äî ${dt ? `<span style="color:#c00;font-weight:700;">${dt}</span>` : '–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è'}`
            : '‚Äî';
        const pp = document.getElementById('premisePeriod');
        if (pp) pp.innerHTML = periodHtml;
    } else {
        setText('premiseResponsible', (a.fio ? `${id} ‚Äî ${a.fio}` : id));
        const pp = document.getElementById('premisePeriod');
        if (pp) pp.innerHTML = '‚Äî';
    }

    // –ø–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞ –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ
    const myLink = regnum ? getActiveLinkForAbonent(id, regnum) : null;
    const mdf = String(myLink?.dateFrom || '').trim();
    const mdt = String(myLink?.dateTo || '').trim();
    const myHtml = (mdf || mdt)
        ? `${mdf || '‚Äî'} ‚Äî ${mdt ? `<span style="color:#c00;font-weight:700;">${mdt}</span>` : '–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è'}`
        : '‚Äî';
    const mp = document.getElementById('premiseMyPeriod');
    if (mp) mp.innerHTML = myHtml;

    // ‚úÖ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ
    try { renderResponsibilityHistory(regnum || a.regnum || ''); } catch(e) {}
    try { renderTransferInfo(id, regnum || a.regnum || ''); } catch(e) {}
}

// üî¥ CRITICAL: –∞–≤—Ç–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ + –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ–ø—É—Å–∫–æ–≤
function __runAutoAccrualRepairOnce(){
    try {
        const id = getAbonentIdFromURL();
        if (!id) return;
        const gk = 'jkh_autoaccrual_repair_once_v1:' + String(id);
        if (sessionStorage.getItem(gk) === '1') return;
        sessionStorage.setItem(gk, '1');

        if (!window.JKHAutoAccrual || typeof window.JKHAutoAccrual.recalcForAbonent !== 'function') return;
        const res = window.JKHAutoAccrual.recalcForAbonent(id);
        if (res && res.ok && res.changed) {
            try { if (window.__loadPaymentTable) window.__loadPaymentTable(); } catch(e) {}
        }
    } catch(e) {
        try { console.warn('[autoaccrual] repairOnce error', e); } catch(_){ }
    }
}

document.addEventListener("DOMContentLoaded", () => {
    fillAbonentCard();
    __runAutoAccrualRepairOnce();
    try { if (window.__loadPaymentTable) window.__loadPaymentTable(); } catch(e) {}
});

function renderResponsibilityHistory(regnum){
  const body = document.getElementById('respHistoryBody');
  if (!body) return;
  body.innerHTML = '';

  const r = String(regnum || '').trim();
  if (!r){
    body.innerHTML = `<tr><td colspan="5" style="border:2px solid #000; padding:6px;">–ù–µ—Ç regnum ‚Äî –∏—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</td></tr>`;
    return;
  }

  const links = getLinks()
    .filter(l => String(l?.regnum || '').trim() === r)
    .slice()
    .sort((a,b) => String(b?.dateFrom||'').localeCompare(String(a?.dateFrom||'')));

  if (!links.length){
    body.innerHTML = `<tr><td colspan="5" style="border:2px solid #000; padding:6px;">–°–≤—è–∑–µ–π (–∏—Å—Ç–æ—Ä–∏–∏) –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>`;
    return;
  }

  const db = getDb();
  links.forEach(l => {
    const aid = String(l?.abonentId || '').trim();
    const fio = String(db[aid]?.fio || '').trim();
    const df = String(l?.dateFrom || '').trim();
    const dt = String(l?.dateTo || '').trim();
    const active = !dt;
    const period = `${df || '‚Äî'} ‚Äî ${dt ? dt : '–ø–æ –Ω–∞—Å—Ç. –≤—Ä–µ–º—è'}`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="border:2px solid #000; padding:6px; ${active ? 'font-weight:700;' : ''}">${period}</td>
      <td style="border:2px solid #000; padding:6px; ${active ? 'font-weight:700;' : ''}">${aid}</td>
      <td style="border:2px solid #000; padding:6px; ${active ? 'font-weight:700;' : ''}">${fio || '‚Äî'}</td>
      <td style="border:2px solid #000; padding:6px; ${active ? 'font-weight:700; color:#0a0;' : ''}">
        ${active ? '—Ç–µ–∫—É—â–∏–π' : '–∑–∞–∫—Ä—ã—Ç'}
      </td>
      <td style="border:2px solid #000; padding:6px;">
        <a href="abonent_card.html?abonent=${encodeURIComponent(aid)}" style="text-decoration:underline;">–æ—Ç–∫—Ä—ã—Ç—å</a>
      </td>
    `;
    body.appendChild(tr);
  });
}

function __r2(n){
  const x = Number(n);
  if (!Number.isFinite(x)) return 0;
  return Math.round(x*100)/100;
}
function __fmt2(n){
  return __r2(n).toFixed(2);
}

function __getFreezeToISO(abonentId){
  try{
    const v = String(localStorage.getItem("jkh_freeze_to_v1:" + String(abonentId)) || "").trim();
    return /^\d{4}-\d{2}-\d{2}$/.test(v) ? v : "";
  }catch(e){ return ""; }
}

function __getIncomingTransfer(abonentId, regnum){
  try{
    const key = "jkh_transfer_balance_v1:" + String(abonentId) + ":" + String(regnum);
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || typeof obj !== "object") return null;
    const startDate = String(obj.startDate || "").trim();
    if (!/^\d{4}-\d{2}-\d{2}$/.test(startDate)) return null;
    return {
      startDate,
      principal: __r2(obj.principal),
      penalty: __r2(obj.penalty),
      fromAbonentId: String(obj.fromAbonentId || "").trim(),
      regnum: String(obj.regnum || regnum || "").trim(),
      mode: String(obj.mode || "").trim()
    };
  }catch(e){ return null; }
}

function __findOutgoingTransfers(fromAbonentId){
  const out = [];
  try{
    for (let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if (!k) continue;
      if (k.indexOf("jkh_transfer_balance_v1:") !== 0) continue;

      const raw = localStorage.getItem(k);
      if (!raw) continue;

      let obj = null;
      try{ obj = JSON.parse(raw); } catch(e){ obj = null; }
      if (!obj || typeof obj !== "object") continue;

      if (String(obj.fromAbonentId || "").trim() !== String(fromAbonentId).trim()) continue;

      out.push({
        key: k,
        toAbonentId: (k.split(":")[1] || "").trim(),
        regnum: (k.split(":").slice(2).join(":") || "").trim(),
        startDate: String(obj.startDate || "").trim(),
        principal: __r2(obj.principal),
        penalty: __r2(obj.penalty),
        mode: String(obj.mode || "").trim()
      });
    }
  }catch(e){}
  out.sort((a,b) => String(b.startDate||"").localeCompare(String(a.startDate||"")));
  return out;
}

function renderTransferInfo(abonentId, regnum){
  const card = document.getElementById("transferCard");
  if (!card) return;

  const incBox = document.getElementById("transferIncoming");
  const frzBox = document.getElementById("transferFreeze");
  const outBox = document.getElementById("transferOutgoing");

  if (incBox) incBox.style.display = "none";
  if (frzBox) frzBox.style.display = "none";
  if (outBox) outBox.style.display = "none";

  const incoming = __getIncomingTransfer(abonentId, regnum);
  const freezeISO = __getFreezeToISO(abonentId);
  const outgoing = __findOutgoingTransfers(abonentId);

  let any = false;

  if (incoming && incBox){
    any = true;
    incBox.style.display = "block";
    document.getElementById("ti_start").textContent = incoming.startDate || "‚Äî";
    document.getElementById("ti_principal").textContent = __fmt2(incoming.principal);
    document.getElementById("ti_penalty").textContent = __fmt2(incoming.penalty);
    // mode/status (human readable)
    const _mraw = String(incoming.mode || "").trim();
    const _m = (_mraw === "WITH_DEBT" || _mraw === "–° –î–û–õ–ì–û–ú") ? "WITH_DEBT" : ((_mraw === "NO_DEBT" || _mraw === "WITHOUT_DEBT" || _mraw === "–ë–ï–ó –î–û–õ–ì–ê") ? "NO_DEBT" : _mraw);
    const _modeText = (_m === "WITH_DEBT") ? "–° –î–û–õ–ì–û–ú" : ((_m === "NO_DEBT") ? "–ë–ï–ó –î–û–õ–ì–ê" : (_mraw || "‚Äî"));
    document.getElementById("ti_mode").textContent = _modeText;

    const _statusEl = document.getElementById("ti_status");
    if (_statusEl){
      if (_m === "WITH_DEBT") {
        _statusEl.textContent = "‚úÖ –î–æ–ª–≥ –∏ –ø–µ–Ω—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã";
      } else if (_m === "NO_DEBT") {
        _statusEl.textContent = "‚õî –î–æ–ª–≥ –∏ –ø–µ–Ω—è –ù–ï –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã";
      } else {
        _statusEl.textContent = "‚Äî";
      }
    }

    const db = getDb();
    const fromId = incoming.fromAbonentId || "";
    const fio = fromId && db[fromId] ? String(db[fromId].fio || "").trim() : "";
    const txt = fromId ? (fio ? `${fromId} ‚Äî ${fio}` : fromId) : "‚Äî";
    const el = document.getElementById("ti_from");
    if (el) {
      if (fromId){
        el.innerHTML = `<a href="abonent_card.html?abonent=${encodeURIComponent(fromId)}">${txt}</a>`;
      } else {
        el.textContent = txt;
      }
    }
  }

  if (freezeISO && frzBox){
    any = true;
    frzBox.style.display = "block";
    document.getElementById("tf_freeze").textContent = freezeISO;
  }

  if (outgoing && outgoing.length && outBox){
    any = true;
    outBox.style.display = "block";
    const wrap = document.getElementById("to_list");
    if (wrap){
      const db = getDb();
      wrap.innerHTML = outgoing.map(o => {
        const toId = o.toAbonentId || "";
        const fio = toId && db[toId] ? String(db[toId].fio || "").trim() : "";
        const toTxt = toId ? (fio ? `${toId} ‚Äî ${fio}` : toId) : "‚Äî";
        const link = toId ? `<a href="abonent_card.html?abonent=${encodeURIComponent(toId)}">${toTxt}</a>` : toTxt;

        return `
          <div class="transfer-item">
            <div><b>–ö–æ–º—É:</b> ${link}</div>
            <div><b>–û–±—ä–µ–∫—Ç:</b> ${o.regnum || "‚Äî"}</div>
            <div><b>–° –¥–∞—Ç—ã:</b> <span class="mono">${o.startDate || "‚Äî"}</span></div>
            <div><b>–î–æ–ª–≥:</b> <span class="mono">${__fmt2(o.principal)}</span> | <b>–ü–µ–Ω—è:</b> <span class="mono">${__fmt2(o.penalty)}</span></div>
            <div><b>–†–µ–∂–∏–º:</b> ${(() => {
              const mr = String(o.mode || "").trim();
              const m = (mr === "WITH_DEBT" || mr === "–° –î–û–õ–ì–û–ú") ? "WITH_DEBT" : ((mr === "NO_DEBT" || mr === "WITHOUT_DEBT" || mr === "–ë–ï–ó –î–û–õ–ì–ê") ? "NO_DEBT" : mr);
              const mt = (m === "WITH_DEBT") ? "–° –î–û–õ–ì–û–ú" : ((m === "NO_DEBT") ? "–ë–ï–ó –î–û–õ–ì–ê" : (mr || "‚Äî"));
              return mt;
            })()}</div>
            <div><b>–°—Ç–∞—Ç—É—Å:</b> ${(() => {
              const mr = String(o.mode || "").trim();
              const m = (mr === "WITH_DEBT" || mr === "–° –î–û–õ–ì–û–ú") ? "WITH_DEBT" : ((mr === "NO_DEBT" || mr === "WITHOUT_DEBT" || mr === "–ë–ï–ó –î–û–õ–ì–ê") ? "NO_DEBT" : mr);
              if (m === "WITH_DEBT") return '<span style="color:#0a6; font-weight:700;">‚úÖ –î–æ–ª–≥ –∏ –ø–µ–Ω—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã</span>';
              if (m === "NO_DEBT") return '<span style="color:#c00; font-weight:700;">‚õî –î–æ–ª–≥ –∏ –ø–µ–Ω—è –ù–ï –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã</span>';
              return '‚Äî';
            })()}</div>
          </div>
        `;
      }).join("");
    }
  }

  card.style.display = any ? "block" : "none";
}

function openResponsibilityReport(){
  const { id, a } = getCurrentAbonent();
  if (!a) { alert('–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  const { regnum } = getPremiseForAbonent(id, a);
  const r = String(regnum || '').trim();
  if (!r) { alert('–ù–µ—Ç regnum ‚Äî –æ—Ç—á—ë—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
  window.location.href = 'responsibility_report.html?regnum=' + encodeURIComponent(r);
}

// ===== –°–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ =====
function openChangeResponsibleModal() {
    const { id, a } = getCurrentAbonent();
    if (!a) { alert('–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

    const { regnum, p } = getPremiseForAbonent(id, a);
    if (!regnum) {
        alert('–£ –∞–±–æ–Ω–µ–Ω—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω —Ä–µ–≥. ‚Ññ –∫–≤ ‚Äî —Å–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.');
        return;
    }

    const premise = p || {};
    const db = getDb();
    const links = getLinks();

    const active = links.find(l => String(l.regnum) === String(regnum) && !String(l.dateTo || '').trim());
    const activeId = active ? String(active.abonentId) : '';

    // –ò–Ω—Ñ–æ
    const addr = [premise.city, premise.street, premise.house, premise.flat].filter(Boolean).join(', ');
    const infoEl = document.getElementById('cr_info');
    if (infoEl) {
        const curName = activeId && db[activeId] ? (db[activeId].fio || '') : (a.fio || '');
        const curDf = String(active?.dateFrom || '').trim();
        infoEl.innerHTML = `–û–±—ä–µ–∫—Ç: <b>${regnum}</b>${addr ? ' ‚Äî ' + addr : ''}<br>` +
            `–¢–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: <b>${activeId || id}</b> ${curName ? '‚Äî ' + curName : ''}` +
            (curDf ? ` (—Å <b>${curDf}</b>)` : '');
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤
    const sel = document.getElementById('cr_newAbonent');
    sel.innerHTML = '';

    const ids = Object.keys(db).sort((x, y) => {
        const nx = Number(x), ny = Number(y);
        if (!Number.isNaN(nx) && !Number.isNaN(ny)) return nx - ny;
        return String(x).localeCompare(String(y), 'ru');
    });

    ids.forEach(k => {
        if (String(k) === String(id)) return;
        const fio = String(db[k]?.fio || '').trim();
        const opt = document.createElement('option');
        opt.value = String(k);
        opt.textContent = fio ? `${k} ‚Äî ${fio}` : String(k);
        sel.appendChild(opt);
    });

    // –î–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const dateInput = document.getElementById('cr_date');
    if (dateInput && !dateInput.value) dateInput.value = `${yyyy}-${mm}-${dd}`;

    document.getElementById('changeResponsibleModal').style.display = 'flex';
}

function closeChangeResponsibleModal() {
    const m = document.getElementById('changeResponsibleModal');
    if (m) m.style.display = 'none';
}

/* ‚úÖ NEW: applyChangeResponsible(mode)
   mode = 'WITH_DEBT' | 'NO_DEBT'
   –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ä–µ–∂–∏–º –ø–µ—Ä–µ–¥–∞—á–∏ (–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö) */
function __saveTransferMeta(newId, regnum, dateFrom, mode){
    try{
        const key = 'jkh_transfer_v1:' + String(newId) + ':' + String(regnum);
        localStorage.setItem(key, JSON.stringify({
            mode: String(mode || 'WITH_DEBT'),
            dateFrom: String(dateFrom || ''),
            regnum: String(regnum || ''),
            ts: new Date().toISOString()
        }));
    }catch(e){}
function __isoMinusOne(iso){
  try{
    const d = new Date(iso + "T12:00:00");
    d.setDate(d.getDate() - 1);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }catch(e){ return iso; }
}

function __saveFreezeTo(oldId, freezeISO){
  try{
    localStorage.setItem("jkh_freeze_to_v1:" + String(oldId), String(freezeISO || ""));
  }catch(e){}
}

function __saveTransferBalance(newId, regnum, startISO, principal, penalty, fromOldId, mode){
  try{
    const key = "jkh_transfer_balance_v1:" + String(newId) + ":" + String(regnum);
    localStorage.setItem(key, JSON.stringify({
      startDate: String(startISO || ""),
      principal: Number(principal || 0),
      penalty: Number(penalty || 0),
      fromAbonentId: String(fromOldId || ""),
      regnum: String(regnum || ""),
      mode: String(mode || "WITH_DEBT"),
      ts: new Date().toISOString()
    }));
  }catch(e){}
}
}

function applyChangeResponsible(mode) {
    if (!canWriteOrExplainLocal()) return;
    const { id, a } = getCurrentAbonent();
    if (!a) { alert('–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

    const { regnum, p } = getPremiseForAbonent(id, a);
    if (!regnum) { alert('–ù–µ—Ç —Ä–µ–≥. ‚Ññ –∫–≤'); return; }

    const newId = String(document.getElementById('cr_newAbonent')?.value || '').trim();
    const dateFrom = String(document.getElementById('cr_date')?.value || '').trim();

    if (!newId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ'); return; }
    if (!dateFrom) { alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –ø–µ—Ä–µ–¥–∞—á–∏'); return; }
    if (String(newId) === String(id)) { alert('–ù–æ–≤—ã–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º'); return; }

    const db = getDb();
    if (!db[String(newId)]) { alert('–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: ' + newId); return; }

    const allLinks = getLinks();

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞
    const otherActive = allLinks.find(l => String(l.abonentId) === String(newId)
        && !String(l.dateTo || '').trim()
        && String(l.regnum) !== String(regnum));
    if (otherActive) {
        alert(`–£ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞: ${otherActive.regnum}.\n` +
              `–°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–æ–π—Ç–µ –µ—ë –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞.`);
        return;
    }

    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ–¥–∞—á–∏ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ —à–∞–≥–∞ —Ä–∞—Å—á—ë—Ç–æ–≤)
    __saveTransferMeta(newId, regnum, dateFrom, mode);


    // ‚úÖ 1) –≤—ã—á–∏—Å–ª—è–µ–º "–¥–æ–ª–≥ + –ø–µ–Ω—è" —É —Å—Ç–∞—Ä–æ–≥–æ –Ω–∞ –¥–∞—Ç—É –ø–µ—Ä–µ–¥–∞—á–∏ (–¥–æ –ø–µ—Ä–µ–¥–∞—á–∏)
    // –°—Ç–∞—Ä—ã–π –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç –Ω–∞–∫–∞–Ω—É–Ω–µ –¥–∞—Ç—ã –ø–µ—Ä–µ–¥–∞—á–∏.
    const freezeISO = __isoMinusOne(dateFrom);

    let oldPrincipal = 0;
    let oldPenalty = 0;

    try{
      const oldPaymentsRaw = localStorage.getItem("payments_" + String(id));
      const oldRows = oldPaymentsRaw ? JSON.parse(oldPaymentsRaw) : [];
      if (window.JKHCalcEngine && typeof window.JKHCalcEngine.calcTotalsAsOfAdjusted === "function"){
        const tot = window.JKHCalcEngine.calcTotalsAsOfAdjusted(oldRows, new Date(freezeISO + "T12:00:00"), {
          abonentId: String(id),
          applyAdvanceOffset: true,
          allowNegativePrincipal: false
        });
        oldPrincipal = Number(tot?.principal || 0);
        oldPenalty   = Number(tot?.penaltyDebt || 0);
      }
    }catch(e){}

    // ‚úÖ 2) –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–≥–æ (–ø–µ–Ω—è –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞—Å—Ç–∏ –ø–æ—Å–ª–µ freezeISO)
    __saveFreezeTo(String(id), freezeISO);

    // ‚úÖ 3) –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—á–∞ "–° –î–û–õ–ì–û–ú" ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–∞–ª—å–¥–æ –Ω–æ–≤–æ–º—É
    if (String(mode) === "WITH_DEBT"){
      __saveTransferBalance(String(newId), String(regnum), String(dateFrom), oldPrincipal, oldPenalty, String(id), "WITH_DEBT");
    } else {
      // "–ë–ï–ó –î–û–õ–ì–ê": –Ω–æ–≤–æ–º—É –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–º
    }


    const activeList = allLinks.filter(l =>
        String(l.regnum) === String(regnum) && !String(l.dateTo || '').trim()
    );

    const currentActive = activeList.length === 1 ? activeList[0] : null;
    const currentActiveId = currentActive ? String(currentActive.abonentId) : "";

    if (currentActiveId && String(currentActiveId) === String(newId)) {
        alert('–≠—Ç–æ—Ç –∞–±–æ–Ω–µ–Ω—Ç —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ –¥–∞–Ω–Ω–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ.');
        return;
    }

    // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞ —É —Å—Ç–∞—Ä–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞
    activeList.forEach(l => {
        const oldAb = db[String(l.abonentId)];
        if (!oldAb) return;
        oldAb.calcEndDate = dateFrom;
        if (window.Data && typeof window.Data.upsertAbonent === 'function') {
            window.Data.upsertAbonent(Object.assign({}, oldAb, { id: String(l.abonentId) }));
        }
    });

    // –∑–∞–∫—Ä—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ links –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ
    activeList.forEach(l => {
        if (window.Data && typeof window.Data.unlinkAbonentFromPremise === 'function') {
            window.Data.unlinkAbonentFromPremise(String(l.abonentId), String(regnum));
        }
        if (window.Data && typeof window.Data.linkAbonentToPremise === 'function') {
            window.Data.linkAbonentToPremise(String(l.abonentId), String(regnum), String(l.dateFrom || ''), String(dateFrom));
        }
    });

    // –æ—Ç–∫—Ä—ã—Ç—å link –Ω–æ–≤–æ–º—É
    if (window.Data && typeof window.Data.linkAbonentToPremise === 'function') {
        window.Data.linkAbonentToPremise(String(newId), String(regnum), String(dateFrom), '');
    }

    // —Å—Ç–∞—Ä—Ç —Ä–∞—Å—á—ë—Ç–∞ —É –Ω–æ–≤–æ–≥–æ
    const newAb = db[String(newId)];
    if (newAb) {
        newAb.calcStartDate = dateFrom;
        newAb.calcEndDate = "";
    }

    // –ø–æ–¥—Ç—è–Ω—É—Ç—å –∞–¥—Ä–µ—Å–Ω—ã–µ –ø–æ–ª—è –∏–∑ premises (–∫–∞–∫ –±—ã–ª–æ)
    const premise = (p || getPremisesDb()[String(regnum)] || {});
    if (newAb) {
        newAb.regnum = String(regnum);
        if (premise.city)   newAb.city = premise.city;
        if (premise.street) newAb.street = premise.street;
        if (premise.house)  newAb.house = premise.house;
        if (premise.flat)   newAb.flat = premise.flat;
        if (premise.square !== undefined && premise.square !== null && premise.square !== "") newAb.square = premise.square;

        if (window.Data && typeof window.Data.upsertAbonent === 'function') {
            window.Data.upsertAbonent(Object.assign({}, newAb, { id: String(newId), premiseRegnum: String(regnum) }));
        }
    }

    // —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ä–µ–∂–∏–º—É
    if (String(mode) === 'NO_DEBT') {
        alert("–ü–µ—Ä–µ–¥–∞—á–∞ –ë–ï–ó –î–û–õ–ì–ê —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.\n–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –≤ —Ä–∞—Å—á—ë—Ç–µ —É—á–∏—Ç—ã–≤–∞–µ–º –æ–±–Ω—É–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞ —Å –¥–∞—Ç—ã –ø–µ—Ä–µ–¥–∞—á–∏.");
    } else {
        alert("–ü–µ—Ä–µ–¥–∞—á–∞ –° –î–û–õ–ì–û–ú —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.");
    }

    window.location.href = 'abonent_card.html?abonent=' + encodeURIComponent(String(newId));
}

/* ===== –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ —É —Ç–µ–±—è) ===== */
function openAbonentEdit() {
    const { id, a } = getCurrentAbonent();
    if (!a) { alert("–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }

    const { regnum, p } = getPremiseForAbonent(id, a);
    const premise = p || {};

    const fioParts = splitFio(a.fio);

    document.getElementById("ae_ls").value = id;

    document.getElementById("ae_regnum").value = regnum || a.regnum || "";
    document.getElementById("ae_city").value   = premise.city || a.city || "";
    document.getElementById("ae_street").value = premise.street || a.street || "";
    document.getElementById("ae_house").value  = premise.house || a.house || "";
    document.getElementById("ae_flat").value   = premise.flat || a.flat || "";

    document.getElementById("ae_last").value  = fioParts.last;
    document.getElementById("ae_first").value = fioParts.first;
    document.getElementById("ae_mid").value   = fioParts.mid;

    document.getElementById("ae_square").value = ((premise.square ?? a.square) ?? "");
    document.getElementById("ae_rooms").value  = a.rooms || "";
    document.getElementById("ae_share").value  = a.share || "";
    document.getElementById("ae_phone").value  = a.phone || "";

    document.getElementById("ae_uid").value = a.uid || "";

    document.getElementById("abonentEditModal").style.display = "flex";
}

function closeAbonentEdit() {
    document.getElementById("abonentEditModal").style.display = "none";
}

function migrateLocalKeys(oldId, newId) {
    const pairs = [
        ["note_", "note_"],
        ["moratorium_", "moratorium_"],
        ["calc_period_", "calc_period_"],
        ["calc_period_active_", "calc_period_active_"],
        ["exclude_periods_", "exclude_periods_"]
    ];

    pairs.forEach(([pOld, pNew]) => {
        const oldKey = pOld + oldId;
        const newKey = pNew + newId;
        const val = localStorage.getItem(oldKey);
        if (val !== null && localStorage.getItem(newKey) === null) {
            localStorage.setItem(newKey, val);
        }
        if (val !== null) localStorage.removeItem(oldKey);
    });
}

function saveAbonentEdit() {
    if (!canWriteOrExplainLocal()) return;
    const { id: oldId, a } = getCurrentAbonent();
    if (!a) { alert("–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }

    const db = getDb();

    const newIdRaw = document.getElementById("ae_ls").value.trim();
    const newId = newIdRaw === "" ? oldId : newIdRaw;

    const last  = document.getElementById("ae_last").value.trim();
    const first = document.getElementById("ae_first").value.trim();
    const mid   = document.getElementById("ae_mid").value.trim();

    const fio = joinFio(last, first, mid);

    if (!newId) { alert("–õ–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"); return; }
    if (!fio) { alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–∞–º–∏–ª–∏—é –∏ –ò–º—è (–º–∏–Ω–∏–º—É–º)"); return; }

    const isIdChanged = String(newId) !== String(oldId);
    if (isIdChanged && db[String(newId)]) {
        alert("–¢–∞–∫–æ–π –ª–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: " + newId);
        return;
    }

    const updated = Object.assign({}, a);
    updated.id = String(newId);
    updated.fio = fio;

    const sq = document.getElementById("ae_square").value;
    updated.square = (sq === "" ? "" : Number(sq));

    updated.rooms = document.getElementById("ae_rooms").value.trim();
    updated.share = document.getElementById("ae_share").value.trim();
    updated.phone = document.getElementById("ae_phone").value.trim();

    if (window.Data && typeof window.Data.upsertAbonent === 'function') {
        window.Data.upsertAbonent(updated);
    }

    if (isIdChanged) {
        if (window.Data && typeof window.Data.getLinksForAbonent === 'function') {
            const oldLinks = window.Data.getLinksForAbonent(String(oldId));
            oldLinks.forEach((l) => {
                if (window.Data && typeof window.Data.unlinkAbonentFromPremise === 'function') {
                    window.Data.unlinkAbonentFromPremise(String(oldId), String(l.regnum || ''));
                }
                if (window.Data && typeof window.Data.linkAbonentToPremise === 'function') {
                    window.Data.linkAbonentToPremise(String(newId), String(l.regnum || ''), String(l.dateFrom || ''), String(l.dateTo || ''));
                }
            });
        }
        if (window.Data && typeof window.Data.deleteAbonent === 'function') {
            window.Data.deleteAbonent(String(oldId));
        }

        migrateLocalKeys(String(oldId), String(newId));

        const url = new URL(window.location.href);
        url.searchParams.set("abonent", String(newId));
        window.history.replaceState({}, "", url.toString());
    }

    closeAbonentEdit();
    fillAbonentCard();

    loadMoratoriumUI();

    if (window.__loadPaymentTable) window.__loadPaymentTable();

    alert("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
    const activeRegnum = String(updated.premiseRegnum || updated.regnum || '').trim();
    if (activeRegnum) renderResponsibilityHistory(activeRegnum);
}

function moratoriumKey(id){ return "moratorium_" + id; }

function loadMoratoriumUI(){
    const id = getAbonentIdFromURL();
    const el = document.getElementById("moratoriumToggle");
    if (!el) return;
    el.checked = localStorage.getItem(moratoriumKey(id)) === "1";
}
function bindMoratoriumUI(){
    const id = getAbonentIdFromURL();
    const el = document.getElementById("moratoriumToggle");
    if (!el) return;
    el.addEventListener("change", () => {
        if (!canWriteOrExplainLocal()) {
            el.checked = localStorage.getItem(moratoriumKey(id)) === "1";
            return;
        }
        localStorage.setItem(moratoriumKey(id), el.checked ? "1" : "0");
        if (window.__loadPaymentTable) window.__loadPaymentTable();
    });
}
document.addEventListener("DOMContentLoaded", () => {
    loadMoratoriumUI();
    bindMoratoriumUI();
});

function openNotesModal() {
    const id = getAbonentIdFromURL();
    const note = localStorage.getItem("note_" + id) || "";
    document.getElementById("notesText").value = note;
    document.getElementById("notesModal").style.display = "flex";
}
function closeNotesModal() {
    document.getElementById("notesModal").style.display = "none";
}
function saveNotes() {
    if (!canWriteOrExplainLocal()) return;
    const id = getAbonentIdFromURL();
    const txt = document.getElementById("notesText").value.trim();
    localStorage.setItem("note_" + id, txt);
    closeNotesModal();
    alert("–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}

function calcPeriodKey(id){ return "calc_period_" + id; }
function calcPeriodActiveKey(id){ return "calc_period_active_" + id; }

function loadCalcPeriodUI(){
    const id = getAbonentIdFromURL();
    const fromEl = document.getElementById("calcFrom");
    const toEl   = document.getElementById("calcTo");
    if (!fromEl || !toEl) return;

    try {
        const raw = localStorage.getItem(calcPeriodKey(id));
        if (raw) {
            const obj = JSON.parse(raw);
            fromEl.value = obj.from || "";
            toEl.value   = obj.to || "";
        } else {
            fromEl.value = "";
            toEl.value   = "";
        }
    } catch {
        fromEl.value = "";
        toEl.value   = "";
    }
}

function saveCalcPeriod(from, to){
    const id = getAbonentIdFromURL();
    localStorage.setItem(calcPeriodKey(id), JSON.stringify({from: from || "", to: to || ""}));
}

function setCalcPeriodActive(active){
    const id = getAbonentIdFromURL();
    localStorage.setItem(calcPeriodActiveKey(id), active ? "1" : "0");
}

function isValidPeriod(from, to){
    if (!from || !to) return false;
    try {
        const a = new Date(from);
        const b = new Date(to);
        return a.toString() !== "Invalid Date" && b.toString() !== "Invalid Date" && a <= b;
    } catch { return false; }
}

function bindCalcButtons(){
    const runBtn = document.getElementById("calcRunBtn");
    const repBtn = document.getElementById("calcReportsBtn");
    const resetBtn = document.getElementById("calcResetBtn");
    const fromEl = document.getElementById("calcFrom");
    const toEl   = document.getElementById("calcTo");
    if (!runBtn || !repBtn || !resetBtn || !fromEl || !toEl) return;

    runBtn.addEventListener("click", () => {
        if (!canWriteOrExplainLocal()) return;
        const from = fromEl.value;
        const to   = toEl.value;

        if (!isValidPeriod(from, to)) {
            saveCalcPeriod("", "");
            setCalcPeriodActive(false);
            if (window.__loadPaymentTable) window.__loadPaymentTable();
            return;
        }

        saveCalcPeriod(from, to);
        setCalcPeriodActive(true);

        if (window.__loadPaymentTable) window.__loadPaymentTable();
    });

    resetBtn.addEventListener("click", () => {
        if (!canWriteOrExplainLocal()) return;
        saveCalcPeriod("", "");
        setCalcPeriodActive(false);
        fromEl.value = "";
        toEl.value = "";
        if (window.__loadPaymentTable) window.__loadPaymentTable();
    });

    repBtn.addEventListener("click", () => {
        const id = getAbonentIdFromURL();
	        // ‚úÖ FIX: forward active db key (if present) to reports page
	        // to keep correct data when multiple bases exist in localStorage.
	        let dbKey = "";
	        try{
	            const p = new URLSearchParams(location.search);
	            dbKey = String(p.get("db") || "").trim();
	        }catch(e){ dbKey = ""; }
	        location.href = "reports.html?abonent=" + encodeURIComponent(id) + (dbKey ? ("&db=" + encodeURIComponent(dbKey)) : "");
    });
}

document.addEventListener("DOMContentLoaded", () => {
    loadCalcPeriodUI();
    bindCalcButtons();
});

document.addEventListener("click", (e) => {
    const m = document.getElementById("abonentEditModal");
    if (!m) return;
    if (m.style.display === "flex" && e.target === m) closeAbonentEdit();
});
</script>

<script>closeLayout();</script>

<!-- –ú–æ–¥–∞–ª–∫–∞: –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
<div id="sourcesModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; width:720px; max-width:95vw; border:2px solid #000; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight:700;">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</div>
      <button class="btn" type="button" onclick="closePaymentSourcesModal()">‚úñ</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px;">
      <input id="sourceNewInput" type="text" placeholder="–ù–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–Ω–∫, –ü–æ—á—Ç–∞, –û–Ω–ª–∞–π–Ω)" style="flex:1; padding:8px; border:2px solid #000;">
      <button class="btn" type="button" onclick="addPaymentSourceFromModal()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div style="margin-top:10px; font-size:12px; opacity:.85;">
      –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ —Ç–µ–∫—É—â–µ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞. –£–¥–∞–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Äî –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∞ –∑–∞–º–µ–Ω–∞.
    </div>

    <div id="sourcesList" style="margin-top:10px; max-height:45vh; overflow:auto; border-top:2px solid #000; padding-top:8px;"></div>

    <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
      <button class="btn" type="button" onclick="closePaymentSourcesModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
(function(){
  function mode(){
    try {
      if (window.Auth && typeof Auth.getActiveDbOwnerId === 'function') return Auth.getActiveDbOwnerId();
      if (window.JKHStorage && typeof JKHStorage.getActiveOwnerId === 'function') return JKHStorage.getActiveOwnerId();
    } catch(e){}
    return 'guest';
  }
  function isGuest(){ return mode()==='guest'; }
  function isAll(){ return mode()==='ALL'; }

  function apply(){
    if (!(isGuest() || isAll())) return;

    var reason = isGuest()
      ? '–ì–æ—Å—Ç—å: —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä (–≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)'
      : "–ê–¥–º–∏–Ω: —Ä–µ–∂–∏–º '–≤—Å–µ –±–∞–∑—ã' ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä (–≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –±–∞–∑—É)";

    var edits = document.querySelectorAll('.edit-link');
    for (var i=0;i<edits.length;i++){ edits[i].style.display='none'; }

    var els = document.querySelectorAll('button, a, [onclick]');
    for (var j=0;j<els.length;j++){
      var el=els[j];
      var oc = (el.getAttribute('onclick')||'').toLowerCase();
      var txt = (el.innerText||'').toLowerCase();
      var dangerous = oc.indexOf('save')>=0 || oc.indexOf('delete')>=0 || oc.indexOf('remove')>=0 || oc.indexOf('add')>=0 ||
                      oc.indexOf('openabonentedit')>=0 ||
                      txt.indexOf('—Å–æ—Ö—Ä–∞–Ω')>=0 || txt.indexOf('—É–¥–∞–ª')>=0 || txt.indexOf('–¥–æ–±–∞–≤')>=0 || txt.indexOf('—Å–º–µ–Ω–∏—Ç—å')>=0;
      if (dangerous) {
        el.style.opacity='0.55';
        el.style.pointerEvents='none';
        el.title = reason;
      }
    }

    var inputs = document.querySelectorAll('input, textarea, select');
    for (var k=0;k<inputs.length;k++){
      try{
        inputs[k].setAttribute('readonly','readonly');
        inputs[k].setAttribute('disabled','disabled');
      }catch(e){}
    }
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', apply);
  else apply();
})();
</script>

</body>
</html>
