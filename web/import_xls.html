<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">

  <script src="auth.js"></script>
  <script src="storage.js"></script>
  <script src="critical_guard.js"></script>

  <title>Импорт Excel (XLSX)</title>
  <link rel="stylesheet" href="style.css">

  <script src="data.js"></script>
  <script src="calc_engine.js"></script>
  <script src="layout.js"></script>
  <script src="xlsx.full.min.js"></script>

  <style>
    .page-wrap { padding: 10px 12px; }
    .block { border: 1px solid #000; background:#fff; padding:10px; margin:10px 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { margin:4px 0; }
    .small { font-size:12px; opacity:0.9; }
    .hint { font-size:12px; opacity:0.85; margin-top:6px; }
    .danger { color:#b00020; font-weight:bold; }
    .ok { color:#0b6b0b; font-weight:bold; }

    .btn { border:1px solid #000; background:#fff; padding:5px 10px; cursor:pointer; font-size:13px; }
    .btn[disabled]{ opacity:0.45; cursor:default; }

    table{ width:100%; border-collapse:collapse; }
    th, td{ border:1px solid #000; padding:4px 6px; font-size:12px; vertical-align:top; }
    thead th{ background:#efefef; position:sticky; top:50px; z-index:10; }

    .status-ok{ background:#eaffea; }
    .status-err{ background:#ffecec; }
    .status-created{ background:#e8f2ff; }
    .status-upd{ background:#fff6e5; }
    .status-skip{ background:#f3f3f3; }
    .status-conflict{ background:#fff0f0; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill{ display:inline-block; padding:1px 6px; border:1px solid #000; background:#fff; font-size:11px; }
    .right{ margin-left:auto; }

    .action-btn { border:1px solid #000; background:#fff; padding:2px 6px; cursor:pointer; font-size:12px; margin-right:6px; }
    .action-btn[disabled]{ opacity:0.45; cursor:default; }
  </style>
</head>

<body>
  <script>renderLayout();</script>

  <div class="page-wrap">
    <h2>ИМПОРТ ДАННЫХ ИЗ EXCEL (XLSX)</h2>

    <div class="block">
      <div class="row">
        <span class="pill"><b>Единый режим:</b> первичка (ФИО/ЛС/площадь/UID) + платежи</span>
        <span class="right small mono" id="whoInfo">—</span>
      </div>

      <div class="row">
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <button class="btn" id="btnParse" disabled>Считать файл (предпросмотр)</button>
        <button class="btn" id="btnImport" disabled>Импортировать</button>
        <button class="btn" id="btnReset" disabled>Сбросить предпросмотр</button>
      </div>

      <div class="row">
        <label class="pill">
          <input type="checkbox" id="optAllowCreate" />
          Разрешить создание абонента из предпросмотра (если не найден)
        </label>
      </div>

      <div class="hint">
        Начисления НЕ импортируются — они считаются автоматически (тариф × площадь).
      </div>
      <div class="hint" id="writeWarning"></div>
    </div>

    <div class="block">
      <div class="row">
        <span class="pill"><b>Итоги предпросмотра</b></span>
        <span class="small mono" id="summaryLine">Файл не выбран</span>
      </div>
      <div class="hint" id="errorsBox"></div>
    </div>

    <div class="block">
      <table>
        <thead>
          <tr>
            <th style="width:70px">Excel</th>
            <th style="width:115px">Статус</th>
            <th style="width:130px">UID</th>
            <th style="width:110px">ЛС</th>
            <th>ФИО</th>
            <th style="width:110px">Тип</th>
            <th style="width:120px">Дата</th>
            <th style="width:140px">Сумма/Площадь</th>
            <th>Сообщение / Действия</th>
          </tr>
        </thead>
        <tbody id="previewBody">
          <tr><td colspan="9" class="small">Нет предпросмотра</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
function $(id){ return document.getElementById(id); }
function normStr(v){ return String(v==null?'':v).trim(); }

// ✅ FIX: кириллицу НЕ вырезаем
function lowKey(s){
  return normStr(s).toLowerCase()
    .replace(/ё/g,'е')
    // Unicode: буквы/цифры/пробел, всё остальное → пробел
    .replace(/[^\p{L}\p{N}\s]/gu,' ')
    .replace(/\s+/g,' ')
    .trim();
}

function nowISODate(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function normNum(v){
  if (v==null) return NaN;
  let s = String(v).trim();
  if (!s) return NaN;
  s = s.replace(/\s+/g,'').replace(',', '.');
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function normDate(v){
  const s = normStr(v);
  if (!s) return "";
  const m1 = s.match(/^(\d{4})[-.\/](\d{1,2})[-.\/](\d{1,2})/);
  if (m1){
    const yy=m1[1], mm=String(+m1[2]).padStart(2,'0'), dd=String(+m1[3]).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  }
  const m2 = s.match(/^(\d{1,2})[-.\/](\d{1,2})[-.\/](\d{4})$/);
  if (m2){
    const dd=String(+m2[1]).padStart(2,'0'), mm=String(+m2[2]).padStart(2,'0'), yy=m2[3];
    return `${yy}-${mm}-${dd}`;
  }
  if (/^\d+(\.\d+)?$/.test(s)){
    try{
      const dc = XLSX.SSF.parse_date_code(Number(s));
      if (dc && dc.y && dc.m && dc.d){
        const yy=String(dc.y), mm=String(dc.m).padStart(2,'0'), dd=String(dc.d).padStart(2,'0');
        return `${yy}-${mm}-${dd}`;
      }
    }catch(e){}
  }
  return "";
}

function canWriteOrExplain(){
  try{
    if (window.Data && typeof Data.ensureWriteOrExplain === 'function'){
      return Data.ensureWriteOrExplain();
    }
  }catch(e){}
  try{
    if (window.JKHStore && typeof JKHStore.canWriteNow === 'function'){
      if (!JKHStore.canWriteNow()){
        $('writeWarning').innerHTML = '<span class="danger">Запись запрещена:</span> гостевой режим или ALL-mode.';
        return false;
      }
    }
  }catch(e){}
  return true;
}

function refreshWho(){
  try{
    const owner = (window.JKHStore && typeof JKHStore.getOwnerId === 'function') ? JKHStore.getOwnerId() : '—';
    $('whoInfo').textContent = 'База: ' + owner;
  }catch(e){
    $('whoInfo').textContent = 'База: —';
  }
}

function getDB(){ return window.AbonentsDB || null; }
function saveDB(){ try{ if (typeof window.saveAbonentsDB === 'function') return window.saveAbonentsDB(); }catch(e){} return null; }

function payKey(ls){ return 'payments_' + String(ls); }
function getPaymentsByLS(ls){
  try{
    return (window.JKHStore && typeof JKHStore.getJSON === 'function')
      ? (JKHStore.getJSON(payKey(ls), [], null) || [])
      : [];
  }catch(e){ return []; }
}
function setPaymentsByLS(ls, arr){
  if (!window.JKHStore || typeof JKHStore.setJSON !== 'function') throw new Error('Нет JKHStore.setJSON');
  return JKHStore.setJSON(payKey(ls), arr, null);
}

function findHeaderRow(aoa){
  const maxScan = Math.min(80, aoa.length);
  for (let r=0; r<maxScan; r++){
    const row = aoa[r] || [];
    let hasUID=false, hasLS=false, hasFam=false, hasSq=false;

    for (let c=0;c<row.length;c++){
      const k = lowKey(row[c]);
      if (!k) continue;

      if (k === 'uid' || k === 'уид' || k.includes('уникальный идентификатор')) hasUID = true;
      if (k === 'лс' || k.includes('лицевой счет') || k.includes('лицевой счёт')) hasLS = true;
      if (k === 'фамилия' || k === 'фам') hasFam = true;
      if (k.includes('площад')) hasSq = true; // "общая площадь" тоже сюда попадает
    }

    if ((hasUID || (hasLS && hasFam)) && hasSq){
      return r;
    }
  }
  return -1;
}

function findPaymentPairs(hdrRow){
  const pairs = [];
  for (let c=0;c<hdrRow.length-1;c++){
    const a = lowKey(hdrRow[c]);
    const b = lowKey(hdrRow[c+1]);
    const isSum = (a === 'сумма' || a.includes('сумма') || a.includes('п п сумма'));
    const isDate = (b === 'дата' || b.includes('дата'));
    if (isSum && isDate){
      pairs.push({ sumCol:c, dateCol:c+1 });
      c++;
    }
  }
  return pairs;
}

function findAbonent(db, uid, ls, fam){
  if (!db || !db.abonents) return { type:'ERR', msg:'База абонентов не загружена' };

  uid = normStr(uid);
  ls  = normStr(ls);
  fam = normStr(fam);

  if (uid){
    if (db.abonents[uid]) return { type:'OK', uid, abonent: db.abonents[uid] };
    return { type:'NONE', msg:'UID не найден' };
  }

  if (!ls || !fam) return { type:'ERR', msg:'Нет UID и нет пары ЛС+Фамилия' };

  const hits = [];
  const keys = Object.keys(db.abonents);
  for (let i=0;i<keys.length;i++){
    const a = db.abonents[keys[i]];
    if (!a) continue;
    const als = normStr(a.id || '');
    const af  = normStr(a.fam || '');
    if (als === ls && af.toLowerCase() === fam.toLowerCase()){
      hits.push({ uid: keys[i], abonent: a });
    }
  }

  if (hits.length === 1) return { type:'OK', uid: hits[0].uid, abonent: hits[0].abonent };
  if (hits.length === 0) return { type:'NONE', msg:'По ЛС+Фамилия абонент не найден' };
  return { type:'AMBIG', msg:`Неоднозначность: найдено ${hits.length} абонента(ов) по ЛС+Фамилия` };
}

function genUID(){ return 'UID_' + String(Date.now()) + '_' + String(Math.floor(Math.random()*10000)).padStart(4,'0'); }
function genTempRegnum(){ return 'TEMP-' + String(Date.now()) + '-' + String(Math.floor(Math.random()*10000)).padStart(4,'0'); }

function createAbonentMinimal(db, desiredUid, ls, fam, name, otch, square){
  const uid = desiredUid ? String(desiredUid) : genUID();
  if (db.abonents[uid]) return { ok:false, msg:'UID уже существует (конфликт)' };

  const fioParts = [fam, name, otch].map(normStr).filter(Boolean);
  const fio = fioParts.join(' ');

  const regnum = genTempRegnum();

  db.abonents[uid] = {
    id: normStr(ls),
    uid: uid,
    fio: fio,
    fam: normStr(fam),
    name: normStr(name),
    otch: normStr(otch),
    square: (Number.isFinite(square) ? square : ""),
    regnum: regnum,
    premiseRegnum: regnum,
    city: "", street: "", house: "", flat: "",
    rooms: "", share: "",
    calcStartDate: "", calcEndDate: "",
    premiseCreatedAt: "2000-01-01"
  };

  return { ok:true, uid, abonent: db.abonents[uid] };
}

function updatePrimary(a, ls, fam, name, otch, square){
  a.id = normStr(ls) || a.id;
  a.fam = normStr(fam) || a.fam;
  a.name = normStr(name) || a.name;
  a.otch = normStr(otch) || a.otch;

  const fioParts = [a.fam, a.name, a.otch].map(normStr).filter(Boolean);
  a.fio = fioParts.join(' ');

  if (Number.isFinite(square)) a.square = square;
}

let WB=null, aoa=null, headerRowIndex=-1, payPairs=[], dataRows=[], preview=[], conflictDecision={};

function setButtons(){
  const hasFile = !!$('fileInput').files && $('fileInput').files.length>0;
  $('btnParse').disabled = !hasFile;

  const hasPreview = preview && preview.length>0;
  $('btnReset').disabled = !hasPreview;

  const canWrite = canWriteOrExplain();
  const hasCritical = preview.some(r => r.status === 'ERROR' && r.critical === true);
  const hasUnresolvedConflict = preview.some(r => r.status === 'CONFLICT' && !r.decision);

  $('btnImport').disabled = !(hasPreview && canWrite && !hasCritical && !hasUnresolvedConflict);
}

function resetPreview(){
  preview = [];
  dataRows = [];
  conflictDecision = {};
  $('previewBody').innerHTML = '<tr><td colspan="9" class="small">Нет предпросмотра</td></tr>';
  $('summaryLine').textContent = 'Предпросмотр сброшен';
  $('errorsBox').innerHTML = '';
  setButtons();
}

function statusRU(s){
  if (s==='OK') return 'ОК';
  if (s==='ERROR') return 'ОШИБКА';
  if (s==='CREATED') return 'СОЗДАН';
  if (s==='UPDATED') return 'ОБНОВЛЁН';
  if (s==='SKIP_DUPLICATE') return 'ДУБЛИКАТ';
  if (s==='CONFLICT') return 'КОНФЛИКТ';
  return s;
}
function statusClass(s){
  if (s==='OK') return 'status-ok';
  if (s==='ERROR') return 'status-err';
  if (s==='CREATED') return 'status-created';
  if (s==='UPDATED') return 'status-upd';
  if (s==='SKIP_DUPLICATE') return 'status-skip';
  if (s==='CONFLICT') return 'status-conflict';
  return '';
}

function renderPreview(){
  const body = $('previewBody');
  body.innerHTML = '';
  if (!preview.length){
    body.innerHTML = '<tr><td colspan="9" class="small">Нет предпросмотра</td></tr>';
    return;
  }

  let ok=0, err=0, created=0, upd=0, dup=0, conf=0;
  const errs = [];

  for (let i=0;i<preview.length;i++){
    const r = preview[i];
    if (r.status==='OK') ok++;
    if (r.status==='ERROR'){ err++; errs.push(r); }
    if (r.status==='CREATED') created++;
    if (r.status==='UPDATED') upd++;
    if (r.status==='SKIP_DUPLICATE') dup++;
    if (r.status==='CONFLICT') conf++;

    const fio = [r.fam,r.name,r.otch].map(normStr).filter(Boolean).join(' ');
    let actionsHTML = '';

    if (r.action && r.action.type === 'ADD_ABONENT'){
      const allow = $('optAllowCreate').checked;
      actionsHTML =
        `<button class="action-btn" data-act="add" data-excelrow="${r.excelRow}" ${allow?'':'disabled'}>Добавить абонента</button>` +
        `<span class="small ${allow?'':'danger'}">${allow?'':'Включи “Разрешить создание абонента”'}</span>`;
    }

    if (r.status === 'CONFLICT'){
      actionsHTML =
        `<button class="action-btn" data-act="conf_over" data-key="${r.confKey}">Принять новый (заменить)</button>` +
        `<button class="action-btn" data-act="conf_keep" data-key="${r.confKey}">Оставить старый</button>` +
        (r.decision ? `<div class="small ok">Решение: ${r.decision==='overwrite'?'заменить':'оставить старый'}</div>` : '');
    }

    const tr = document.createElement('tr');
    tr.className = statusClass(r.status);
    tr.innerHTML = `
      <td class="mono">${r.excelRow}</td>
      <td><b>${statusRU(r.status)}</b></td>
      <td class="mono">${r.uid||''}</td>
      <td class="mono">${r.ls||''}</td>
      <td>${fio}</td>
      <td class="mono">${r.kind||''}</td>
      <td class="mono">${r.date||''}</td>
      <td class="mono">${(r.value!=null)?r.value:''}</td>
      <td>${r.msg||''}<div style="margin-top:4px">${actionsHTML}</div></td>
    `;
    body.appendChild(tr);
  }

  $('summaryLine').textContent =
    `ОК=${ok} | ОШИБКА=${err} | СОЗДАН=${created} | ОБНОВЛЁН=${upd} | ДУБЛИКАТ=${dup} | КОНФЛИКТ=${conf} | Всего=${preview.length}`;

  if (errs.length){
    const lines = errs.slice(0, 40).map(e =>
      `<div class="danger mono">Excel ${e.excelRow}: ${e.msg}</div>`
    ).join('');
    $('errorsBox').innerHTML = `<div><b class="danger">Ошибки:</b></div>${lines}` +
      (errs.length>40 ? `<div class="small">…и ещё ${errs.length-40} ошибок</div>` : '');
  } else {
    $('errorsBox').innerHTML = `<div class="ok">Критических ошибок нет.</div>`;
  }

  setButtons();
}

function parseSheetToRows(sheet){
  aoa = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

  headerRowIndex = findHeaderRow(aoa);
  if (headerRowIndex < 0){
    return { ok:false, msg:'Не нашёл строку заголовков (UID/ЛС/Фамилия/Площадь). В твоём шаблоне это обычно строка 14.' };
  }

  const hdrRow = aoa[headerRowIndex];
  payPairs = findPaymentPairs(hdrRow);

  // индексы по факту заголовков твоей строки 14:
  const idxUID = hdrRow.findIndex(x => lowKey(x)==='uid' || lowKey(x)==='уид');
  const idxLS  = hdrRow.findIndex(x => lowKey(x)==='лс' || lowKey(x).includes('лицевой'));
  const idxFAM = hdrRow.findIndex(x => lowKey(x)==='фамилия' || lowKey(x)==='фам');
  const idxNAM = hdrRow.findIndex(x => lowKey(x)==='имя');
  const idxOTC = hdrRow.findIndex(x => lowKey(x)==='отчество');
  const idxSQ  = hdrRow.findIndex(x => lowKey(x).includes('площад'));

  if (idxFAM < 0) return { ok:false, msg:'Не найдена колонка "Фамилия".' };
  if (idxSQ < 0)  return { ok:false, msg:'Не найдена колонка "Общая площадь".' };
  if (idxLS < 0 && idxUID < 0) return { ok:false, msg:'Не найдены колонки UID или ЛС.' };

  const rows = [];
  for (let r=headerRowIndex+1; r<aoa.length; r++){
    const line = aoa[r] || [];
    const allEmpty = line.every(c => normStr(c)==='');
    if (allEmpty) continue;

    const uid = (idxUID>=0) ? line[idxUID] : '';
    const ls  = (idxLS>=0)  ? line[idxLS]  : '';
    const fam = line[idxFAM];
    const name= (idxNAM>=0) ? line[idxNAM] : '';
    const otch= (idxOTC>=0) ? line[idxOTC] : '';
    const sq  = normNum(line[idxSQ]);

    const pays = [];
    for (let i=0;i<payPairs.length;i++){
      const pc = payPairs[i];
      pays.push({ amount: line[pc.sumCol], date: line[pc.dateCol] });
    }

    rows.push({ excelRow:(r+1), uid, ls, fam, name, otch, square:sq, payments:pays });
  }

  return { ok:true, rows, msg:`Заголовки найдены на строке ${headerRowIndex+1}. Пар платежей (Сумма+Дата): ${payPairs.length}.` };
}

function buildPreviewChain(){
  const db = getDB();
  preview = [];

  if (!db || !db.abonents){
    preview.push({ excelRow:'—', status:'ERROR', critical:true, msg:'База абонентов не загружена (AbonentsDB отсутствует).' });
    renderPreview();
    return;
  }

  const today = nowISODate();

  for (let i=0;i<dataRows.length;i++){
    const r = dataRows[i];
    const uid = normStr(r.uid);
    const ls  = normStr(r.ls);
    const fam = normStr(r.fam);
    const name= normStr(r.name);
    const otch= normStr(r.otch);
    const square = r.square;

    if (!uid && (!ls || !fam)){
      preview.push({ excelRow:r.excelRow, status:'ERROR', critical:true, uid, ls, fam, name, otch, kind:'ИД',
        msg:'Нет UID и нет пары ЛС+Фамилия — идентификация невозможна.' });
      continue;
    }

    const found = findAbonent(db, uid, ls, fam);

    if (found.type === 'AMBIG' || found.type === 'ERR'){
      preview.push({ excelRow:r.excelRow, status:'ERROR', critical:true, uid, ls, fam, name, otch, kind:'ИД', msg: found.msg });
      continue;
    }

    if (found.type !== 'OK'){
      preview.push({
        excelRow:r.excelRow, status:'ERROR', critical:true,
        uid, ls, fam, name, otch, kind:'АБОНЕНТ',
        msg:'Абонент не найден. Можно добавить через кнопку ниже (если UID пуст).',
        action:{ type:'ADD_ABONENT' }
      });
      continue;
    }

    const abonentLS = normStr(found.abonent.id || ls);

    // первичка
    if (!Number.isFinite(square)){
      preview.push({ excelRow:r.excelRow, status:'ERROR', critical:true, uid:found.uid, ls:abonentLS, fam, name, otch, kind:'ПЕРВИЧКА',
        value:square, msg:'Первичка: неверная/пустая площадь.' });
    } else {
      preview.push({ excelRow:r.excelRow, status:'UPDATED', critical:false, uid:found.uid, ls:abonentLS, fam, name, otch, kind:'ПЕРВИЧКА',
        value:square, msg:'Будет обновлена первичка (ФИО/ЛС/площадь)' });
    }

    // платежи
    for (let p=0;p<r.payments.length;p++){
      const pay = r.payments[p];
      if (!normStr(pay.date) && !normStr(pay.amount)) continue;

      const date = normDate(pay.date);
      const amount = normNum(pay.amount);

      if (!date || !Number.isFinite(amount)){
        preview.push({ excelRow:r.excelRow, status:'ERROR', critical:true, uid:found.uid, ls:abonentLS, fam, name, otch, kind:'ПЛАТЁЖ',
          date, value:amount, msg:'Платёж: нужна и дата, и сумма (обе).' });
        continue;
      }

      if (date > today){
        preview.push({ excelRow:r.excelRow, status:'ERROR', critical:true, uid:found.uid, ls:abonentLS, fam, name, otch, kind:'ПЛАТЁЖ',
          date, value:amount, msg:`Дата платежа (${date}) позже текущей (${today}).` });
        continue;
      }

      if (amount <= 0){
        preview.push({ excelRow:r.excelRow, status:'ERROR', critical:true, uid:found.uid, ls:abonentLS, fam, name, otch, kind:'ПЛАТЁЖ',
          date, value:amount, msg:'Сумма платежа должна быть > 0.' });
        continue;
      }

      const list = getPaymentsByLS(abonentLS);
      const exactDup = list.some(x => String(x.date||'')===date && Number(x.amount||0)===amount);
      if (exactDup){
        preview.push({ excelRow:r.excelRow, status:'SKIP_DUPLICATE', critical:false, uid:found.uid, ls:abonentLS, fam, name, otch, kind:'ПЛАТЁЖ',
          date, value:amount, msg:'Дубликат (дата+сумма) — будет пропущен.' });
        continue;
      }

      const sameDate = list.find(x => String(x.date||'')===date);
      if (sameDate){
        const confKey = `${abonentLS}::${date}`;
        const decision = conflictDecision[confKey] || '';
        preview.push({ excelRow:r.excelRow, status:'CONFLICT', critical:false, uid:found.uid, ls:abonentLS, fam, name, otch, kind:'ПЛАТЁЖ',
          date, value:amount, msg:`КОНФЛИКТ: уже есть платёж на ${date} суммой ${sameDate.amount}. Выбери действие.`,
          confKey, decision });
        continue;
      }

      preview.push({ excelRow:r.excelRow, status:'OK', critical:false, uid:found.uid, ls:abonentLS, fam, name, otch, kind:'ПЛАТЁЖ',
        date, value:amount, msg:'Будет добавлен платёж.' });
    }
  }

  renderPreview();
}

function applyImport(){
  if (!canWriteOrExplain()) { setButtons(); return; }

  const db = getDB();
  if (!db || !db.abonents){ alert('База абонентов не загружена.'); return; }

  const hasCritical = preview.some(r => r.status === 'ERROR' && r.critical === true);
  if (hasCritical){ alert('Импорт заблокирован: есть критические ошибки в предпросмотре.'); return; }

  const hasUnresolvedConflict = preview.some(r => r.status === 'CONFLICT' && !conflictDecision[r.confKey]);
  if (hasUnresolvedConflict){ alert('Импорт заблокирован: есть КОНФЛИКТЫ платежей, нужно выбрать действие.'); return; }

  let updated=0, payAdded=0, paySkipped=0, payOver=0;
  const today = nowISODate();

  // первичка + платежи
  for (let i=0;i<dataRows.length;i++){
    const r = dataRows[i];
    const uid = normStr(r.uid);
    const ls  = normStr(r.ls);
    const fam = normStr(r.fam);
    const name= normStr(r.name);
    const otch= normStr(r.otch);
    const square = r.square;

    const found = findAbonent(db, uid, ls, fam);
    if (found.type !== 'OK') continue;

    const abonentLS = normStr(found.abonent.id || ls);

    if (Number.isFinite(square)){
      updatePrimary(found.abonent, ls, fam, name, otch, square);
      updated++;
    }

    let list = getPaymentsByLS(abonentLS);

    for (let p=0;p<r.payments.length;p++){
      const pay = r.payments[p];
      if (!normStr(pay.date) && !normStr(pay.amount)) continue;

      const date = normDate(pay.date);
      const amount = normNum(pay.amount);

      if (!date || !Number.isFinite(amount) || amount<=0) { paySkipped++; continue; }
      if (date > today) { paySkipped++; continue; }

      const exactDup = list.some(x => String(x.date||'')===date && Number(x.amount||0)===amount);
      if (exactDup){ paySkipped++; continue; }

      const sameDateIndex = list.findIndex(x => String(x.date||'')===date);
      if (sameDateIndex >= 0){
        const confKey = `${abonentLS}::${date}`;
        const decision = conflictDecision[confKey];
        if (decision === 'overwrite'){
          list[sameDateIndex] = { date, amount };
          payOver++;
        } else {
          paySkipped++;
        }
        continue;
      }

      list.push({ date, amount });
      payAdded++;
    }

    list.sort((a,b) => String(a.date||'').localeCompare(String(b.date||'')));
    setPaymentsByLS(abonentLS, list);
  }

  try{ saveDB(); }catch(e){}

  alert(
    'Импорт завершён.\n\n' +
    'Первичка обновлена: ' + updated + '\n' +
    'Платежей добавлено: ' + payAdded + '\n' +
    'Платежей заменено (конфликт): ' + payOver + '\n' +
    'Платежей пропущено: ' + paySkipped
  );

  resetPreview();
}

function readFileAsArrayBuffer(file){
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = () => reject(fr.error || new Error('Ошибка чтения файла'));
    fr.readAsArrayBuffer(file);
  });
}

async function onParse(){
  $('writeWarning').innerHTML = '';
  refreshWho();

  const file = $('fileInput').files[0];
  if (!file) return;

  let buf;
  try{ buf = await readFileAsArrayBuffer(file); }
  catch(e){ alert('Не удалось прочитать файл: ' + (e && e.message ? e.message : e)); return; }

  try{ WB = XLSX.read(buf, { type:'array' }); }
  catch(e){ alert('Не удалось распарсить XLSX: ' + (e && e.message ? e.message : e)); return; }

  if (!WB.SheetNames || !WB.SheetNames.length){ alert('В книге нет листов.'); return; }

  const sheet = WB.Sheets[WB.SheetNames[0]];
  const res = parseSheetToRows(sheet);

  if (!res.ok){
    preview = [{ excelRow:'—', status:'ERROR', critical:true, msg:res.msg }];
    renderPreview();
    return;
  }

  dataRows = res.rows;
  conflictDecision = {};
  buildPreviewChain();
}

$('previewBody').addEventListener('click', (ev) => {
  const btn = ev.target.closest('button[data-act]');
  if (!btn) return;

  const act = btn.getAttribute('data-act');

  if (act === 'add'){
    const allow = $('optAllowCreate').checked;
    if (!allow) return;

    const excelRow = Number(btn.getAttribute('data-excelrow'));
    const db = getDB();
    if (!db || !db.abonents) return;

    const row = dataRows.find(x => x.excelRow === excelRow);
    if (!row) return;

    const uid = normStr(row.uid);
    const ls  = normStr(row.ls);
    const fam = normStr(row.fam);
    const name= normStr(row.name);
    const otch= normStr(row.otch);
    const square = row.square;

    if (uid){
      alert('В этой строке указан UID. Создание из предпросмотра разрешено только когда UID пуст.');
      return;
    }
    if (!ls || !fam){ alert('Нельзя создать абонента: не хватает ЛС или Фамилии.'); return; }
    if (!Number.isFinite(square)){ alert('Нельзя создать абонента: неверная/пустая площадь.'); return; }

    const cr = createAbonentMinimal(db, null, ls, fam, name, otch, square);
    if (!cr.ok){ alert('Не удалось создать абонента: ' + cr.msg); return; }

    try{ saveDB(); }catch(e){}
    buildPreviewChain();
    return;
  }

  if (act === 'conf_over' || act === 'conf_keep'){
    const key = btn.getAttribute('data-key');
    if (!key) return;
    conflictDecision[key] = (act === 'conf_over') ? 'overwrite' : 'keep';
    buildPreviewChain();
    return;
  }
});

(function init(){
  refreshWho();

  $('fileInput').addEventListener('change', () => { resetPreview(); setButtons(); });
  $('optAllowCreate').addEventListener('change', () => { renderPreview(); });

  $('btnParse').addEventListener('click', onParse);
  $('btnReset').addEventListener('click', resetPreview);
  $('btnImport').addEventListener('click', applyImport);

  setButtons();
})();
</script>

<script>closeLayout();</script>
</body>
</html>
