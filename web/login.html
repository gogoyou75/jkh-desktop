<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Вход в программу</title>
  <script src="auth.js" defer></script>

  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#fff;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .wrap{
      width: 880px;
      max-width: calc(100vw - 40px);
    }

    h2{
      margin:0 0 10px 0;
      font-size: 26px;
      font-weight: 700;
    }

    .box{
      border:2px solid #000;
      padding:14px 16px;
      background:#fff;
    }

    .tabs{
      display:flex;
      gap:10px;
      margin: 0 0 14px 0;
    }

    .tab{
      border:1px solid #000;
      background:#fff;
      padding:6px 12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      background:#efefef;
      font-weight:700;
    }

    .row{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      align-items:center;
      margin:10px 0;
      max-width: 620px;
    }
    .row label{
      font-size:13px;
    }
    input, select{
      border:1px solid #000;
      padding:6px 8px;
      font-size:13px;
      width: 100%;
      box-sizing:border-box;
    }

    .opts{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      margin-top: 6px;
      max-width: 620px;
      align-items:start;
    }
    .opts .optcol{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-top:3px;
      font-size:13px;
    }

    .hint{
      margin-top: 8px;
      font-size:12px;
      line-height:1.35;
      max-width: 760px;
    }

    .btn{
      margin-top: 14px;
      border:1px solid #000;
      background:#fff;
      padding:6px 16px;
      cursor:pointer;
      font-size:13px;
      font-weight:700;
    }

    .status{
      border:2px solid #000;
      background:#fff6e5;
      padding:8px 10px;
      font-size:12px;
      margin-bottom:12px;
      display:none;
    }

    .panel{ display:none; }
    .panel.active{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <h2>Вход в программу</h2>

    <div class="box">

      <div id="statusBox" class="status"></div>

      <div class="tabs">
        <div class="tab active" data-tab="login">Вход</div>
        <div class="tab" data-tab="register">Регистрация</div>
        <div class="tab" data-tab="recover">Восстановление</div>
      </div>

      <!-- LOGIN -->
      <div class="panel active" id="panel-login">
        <form id="loginForm" autocomplete="on">
          <div class="row">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" name="username" autocomplete="username">
          </div>

          <div class="row">
            <label for="loginPass">Пароль</label>
            <input id="loginPass" type="password" name="password" autocomplete="current-password">
          </div>

          <div class="row">
            <label for="loginRemember">Запомнить</label>
            <select id="loginRemember">
              <option value="0">нет</option>
              <option value="7">на 7 дней</option>
              <option value="30" selected>на 30 дней</option>
            </select>
          </div>

          <div class="opts">
            <label>Опции</label>
            <div class="optcol">
              <label><input type="checkbox" id="rememberEmail" checked> Запомнить e-mail</label>
              <label><input type="checkbox" id="savePassBrowser" disabled checked> Сохранить пароль (в браузере)</label>
            </div>
          </div>

          <div class="hint">
            Пароль сохраняет сам браузер (если поддерживает). В программе пароль не хранится в открытом виде.
          </div>

          <button class="btn" type="submit">Войти</button>

          <div class="hint" style="margin-top:12px;">
            Офлайн-режим: письма не отправляются. Восстановление делается через recovery-коды или мастер-ключ администратора.
          </div>
        </form>
      </div>

      <!-- REGISTER -->
      <div class="panel" id="panel-register">
        <form id="registerForm" autocomplete="on">
          <div class="row">
            <label for="registerEmail">Email</label>
            <input id="registerEmail" type="email" autocomplete="username">
          </div>

          <div class="row">
            <label for="registerPass">Пароль</label>
            <input id="registerPass" type="password" autocomplete="new-password">
          </div>

          <div class="row">
            <label for="registerPass2">Повтор пароля</label>
            <input id="registerPass2" type="password" autocomplete="new-password">
          </div>

          <div class="row">
            <label for="registerName">Имя (необязательно)</label>
            <input id="registerName" type="text" autocomplete="name">
          </div>

          <div class="hint" style="margin-top:12px;">
            <strong>Внимание:</strong> При первой регистрации в системе будет создан первый администратор.
            Если система уже содержит пользователей, будет создан обычный пользователь.
          </div>

          <button class="btn" type="submit">Зарегистрироваться</button>
        </form>
      </div>

      <!-- RECOVER -->
      <div class="panel" id="panel-recover">
        <div class="hint" style="font-size:13px;">
          Восстановление выполняется офлайн: recovery-код или мастер-ключ администратора.
        </div>
      </div>

    </div>
  </div>

<script>
  // tabs (без стрелок для совместимости)
  (function(){
    var tabs = document.querySelectorAll('.tab');
    for (var i=0;i<tabs.length;i++){
      tabs[i].addEventListener('click', (function(t){
        return function(){
          for (var j=0;j<tabs.length;j++) tabs[j].classList.remove('active');
          t.classList.add('active');

          var panels = document.querySelectorAll('.panel');
          for (var k=0;k<panels.length;k++) panels[k].classList.remove('active');

          var pid = 'panel-' + t.getAttribute('data-tab');
          var p = document.getElementById(pid);
          if (p) p.classList.add('active');
        };
      })(tabs[i]));
    }
  })();

  function showStatus(msg, isError){
    var b = document.getElementById('statusBox');
    b.textContent = msg;
    b.style.display = 'block';
    b.style.background = isError ? '#ffe6e6' : '#f0fff0';
    b.style.borderColor = isError ? '#d00' : '#0a0';
  }
  function hideStatus(){
    var b = document.getElementById('statusBox');
    b.style.display = 'none';
    b.textContent = '';
  }

  // email prefill
  document.addEventListener('DOMContentLoaded', function(){
    try{
      if (window.Auth && typeof Auth.getLastEmail === 'function'){
        var e = Auth.getLastEmail();
        if (e) {
          document.getElementById('loginEmail').value = e;
          document.getElementById('registerEmail').value = e;
        }
      }
    }catch(e){}
  });

  // ========== ВХОД ==========
  document.getElementById('loginForm').addEventListener('submit', function (e){
    e.preventDefault();
    hideStatus();

    var emailEl = document.getElementById('loginEmail');
    var passEl  = document.getElementById('loginPass');
    var daysEl  = document.getElementById('loginRemember');

    var email = (emailEl.value || '').trim();
    var pass  = (passEl.value || '');
    var days  = parseInt(daysEl.value, 10) || 0;

    if (!email) {
      showStatus('Введите email', true);
      emailEl.focus();
      return;
    }
    if (!pass) {
      showStatus('Введите пароль', true);
      passEl.focus();
      return;
    }

    try{
      // запомнить email (опция)
      if (document.getElementById('rememberEmail').checked && window.Auth && typeof Auth.setLastEmail === 'function'){
        Auth.setLastEmail(email);
      }

      // Используем loginByPassword, который автоматически создаст первого админа при пустой базе
      if (window.Auth && typeof Auth.loginByPassword === 'function') {
        Auth.loginByPassword(email, pass, days).then(function(user){
          // Успешный вход
          showStatus('Вход выполнен успешно! Перенаправление...', false);
          
          // Проверяем редирект из URL
          var urlParams = new URLSearchParams(window.location.search);
          var redirect = urlParams.get('redirect');
          
          // Задержка для отображения сообщения об успехе
          setTimeout(function(){
            if (redirect && (redirect === 'index.html' || redirect.endsWith('.html'))) {
              location.href = redirect;
            } else {
              location.href = 'index.html';
            }
          }, 500);
        }).catch(function(err){
          showStatus('Не удалось войти: ' + (err && err.message ? err.message : err), true);
        });
      } else {
        showStatus('Ошибка: Auth.loginByPassword не найден', true);
      }

    }catch(err){
      showStatus('Не удалось войти: ' + (err && err.message ? err.message : err), true);
    }
  });

  // ========== РЕГИСТРАЦИЯ ==========
  document.getElementById('registerForm').addEventListener('submit', function (e){
    e.preventDefault();
    hideStatus();

    var emailEl = document.getElementById('registerEmail');
    var passEl = document.getElementById('registerPass');
    var pass2El = document.getElementById('registerPass2');
    var nameEl = document.getElementById('registerName');

    var email = (emailEl.value || '').trim();
    var pass = (passEl.value || '');
    var pass2 = (pass2El.value || '');
    var name = (nameEl.value || '').trim();

    // Валидация
    if (!email) {
      showStatus('Введите email', true);
      emailEl.focus();
      return;
    }
    if (!pass) {
      showStatus('Введите пароль', true);
      passEl.focus();
      return;
    }
    if (pass.length < 4) {
      showStatus('Пароль слишком короткий (мин. 4 символа)', true);
      passEl.focus();
      return;
    }
    if (pass !== pass2) {
      showStatus('Пароли не совпадают', true);
      pass2El.focus();
      return;
    }

    try {
      // Проверяем, есть ли функция registerUser, если нет - используем registerFirstAdmin
      var registerFunc = null;
      if (window.Auth && typeof Auth.registerUser === 'function') {
        registerFunc = Auth.registerUser;
      } else if (window.Auth && typeof Auth.registerFirstAdmin === 'function') {
        registerFunc = Auth.registerFirstAdmin;
      }

      if (!registerFunc) {
        showStatus('Ошибка: функция регистрации не найдена', true);
        return;
      }

      // Определяем роль: если база пустая - админ, иначе обычный пользователь
      var role = 'user';
      if (window.Auth && typeof Auth.usersCount === 'function') {
        try {
          var count = Auth.usersCount();
          if (count === 0) role = 'admin';
        } catch(e) {}
      }

      // Для совместимости: если используется registerFirstAdmin, передаем только нужные параметры
      if (registerFunc === Auth.registerFirstAdmin) {
        registerFunc(email, pass, name).then(function(result){
          // После регистрации автоматически входим
          if (window.Auth && typeof Auth.loginByPassword === 'function') {
            return Auth.loginByPassword(email, pass, 30);
          }
          return Promise.reject(new Error('Не удалось войти после регистрации'));
        }).then(function(user){
          showStatus('Регистрация выполнена успешно! Вы вошли как ' + (user.role === 'admin' ? 'администратор' : 'пользователь'), false);
          
          // Запоминаем email
          if (window.Auth && typeof Auth.setLastEmail === 'function'){
            Auth.setLastEmail(email);
          }
          
          setTimeout(function(){
            location.href = 'index.html';
          }, 1000);
        }).catch(function(err){
          showStatus('Ошибка регистрации: ' + (err && err.message ? err.message : err), true);
        });
      } else {
        // Используем registerUser
        registerFunc(email, pass, name, role).then(function(result){
          // После регистрации автоматически входим
          if (window.Auth && typeof Auth.loginByPassword === 'function') {
            return Auth.loginByPassword(email, pass, 30);
          }
          return Promise.reject(new Error('Не удалось войти после регистрации'));
        }).then(function(user){
          showStatus('Регистрация выполнена успешно! Вы вошли как ' + (user.role === 'admin' ? 'администратор' : 'пользователь'), false);
          
          // Запоминаем email
          if (window.Auth && typeof Auth.setLastEmail === 'function'){
            Auth.setLastEmail(email);
          }
          
          setTimeout(function(){
            location.href = 'index.html';
          }, 1000);
        }).catch(function(err){
          showStatus('Ошибка регистрации: ' + (err && err.message ? err.message : err), true);
        });
      }
    } catch(err) {
      showStatus('Ошибка регистрации: ' + (err && err.message ? err.message : err), true);
    }
  });
</script>
</body>
</html>