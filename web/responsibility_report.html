<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–û—Ç—á—ë—Ç: –∫—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</title>
  <link rel="stylesheet" href="style.css">
  <script src="data.js"></script>
  <script src="layout.js"></script>
  <style>
    .card{border:2px solid #000; background:#fff; padding:14px; margin-top:10px;}
    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{border:2px solid #000; padding:6px; vertical-align:top;}
    .muted{opacity:.8; font-size:12px;}
    .row{display:flex; gap:10px; align-items:end; flex-wrap:wrap;}
    .row label{font-size:13px; display:flex; flex-direction:column; gap:6px;}
    input{border:2px solid #000; height:28px; padding:2px 6px; font-size:13px;}
    button{border:2px solid #000; padding:6px 10px; background:#e5e5e5; cursor:pointer;}
    .hdrline{font-weight:700; line-height:1.35;}
    .hdrsub{margin-top:6px; font-size:13px;}
    .hdrsub b{font-weight:700;}
    @media print {
      .no-print{display:none !important;}
      body{background:#fff;}
    }
  </style>
</head>
<body>
<script>renderLayout();</script>

<h2>–û—Ç—á—ë—Ç –¥–ª—è —Å—É–¥–∞: –∫—Ç–æ –±—ã–ª –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º</h2>

<div class="card">
  <div id="hdr" class="hdrline"></div>
  <div id="hdrAddr" class="hdrsub"></div>

  <div class="muted" style="margin-top:6px;">
    üî¥ CRITICAL: –æ—Ç—á—ë—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (links). –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è –∞–±–æ–Ω–µ–Ω—Ç–∞ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è.
  </div>

  <div class="row no-print" style="margin-top:12px;">
    <label>–ü–µ—Ä–∏–æ–¥ —Å
      <input type="date" id="from">
    </label>
    <label>–ø–æ
      <input type="date" id="to">
    </label>
    <button type="button" onclick="run()">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
    <button type="button" onclick="window.print()">–ü–µ—á–∞—Ç—å</button>
    <button type="button" onclick="history.back()">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<div class="card">
  <div style="font-weight:700; margin-bottom:8px;">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
  <table>
    <thead>
      <tr>
        <th style="width:170px;">–ü–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (–≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞)</th>
        <th style="width:90px;">–õ–°</th>
        <th>–§–ò–û</th>
        <th style="width:140px;">–û—Å–Ω–æ–≤–∞–Ω–∏–µ</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
function q(name){ return document.getElementById(name); }

// ===== –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º (CANON: Data-—Å–ª–æ–π –∏–ª–∏ AbonentsDB) =====
function getLinks(){
  // –µ—Å–ª–∏ Data-—Å–ª–æ–π –µ—Å—Ç—å ‚Äî –æ–Ω –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ, –Ω–æ –∑–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
  try {
    if (window.Data && typeof window.Data.getDb === 'function') {
      const db = window.Data.getDb();
      return Array.isArray(db?.links) ? db.links : [];
    }
  } catch(e){}
  return Array.isArray(window.AbonentsDB?.links) ? window.AbonentsDB.links : [];
}
function getDb(){
  try {
    if (window.Data && typeof window.Data.getDb === 'function') {
      const db = window.Data.getDb();
      return db?.abonents || {};
    }
  } catch(e){}
  return window.AbonentsDB?.abonents || {};
}
function getPremises(){
  try {
    if (window.Data && typeof window.Data.getDb === 'function') {
      const db = window.Data.getDb();
      return db?.premises || {};
    }
  } catch(e){}
  return window.AbonentsDB?.premises || {};
}

function parseISO(s){
  const v = String(s||'').trim();
  if(!v) return null;
  const d = new Date(v);
  return isNaN(d.getTime()) ? null : d;
}
function fmtISO(d){
  if(!d) return '';
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function maxDate(a,b){ return a && b ? (a>b?a:b) : (a||b); }
function minDate(a,b){ return a && b ? (a<b?a:b) : (a||b); }

// ===== –ê–¥—Ä–µ—Å: –±–µ—Ä—ë–º –∏–∑ premises, –∞ –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏–∑ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤ –ø–æ links =====
function buildAddrFromPremise(p){
  if(!p) return '';
  const city = String(p.city||'').trim();
  const street = String(p.street||'').trim();
  const house = String(p.house||'').trim();
  const flat = String(p.flat||'').trim();
  return [city, street, house, flat].filter(Boolean).join(', ');
}
function buildAddrFromAbonent(a){
  if(!a) return '';
  const city = String(a.city||'').trim();
  const street = String(a.street||'').trim();
  const house = String(a.house||'').trim();
  const flat = String(a.flat||'').trim();
  return [city, street, house, flat].filter(Boolean).join(', ');
}
function resolveAddressByRegnum(regnum){
  const r = String(regnum||'').trim();
  if(!r) return '';

  const prem = getPremises()[r] || null;
  const addrP = buildAddrFromPremise(prem);
  if (addrP) return addrP;

  // fallback: –ø–æ–ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∞–¥—Ä–µ—Å –∏–∑ –ª—é–±–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç –ø–æ —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ –≤ links
  const links = getLinks().filter(l => String(l?.regnum||'').trim() === r);
  const db = getDb();
  for (let i=0;i<links.length;i++){
    const aid = String(links[i]?.abonentId||'').trim();
    const a = db[aid] || null;
    const addrA = buildAddrFromAbonent(a);
    if (addrA) return addrA;
  }
  return '';
}

function splitByPeriod(regnum, from, to){
  const r = String(regnum||'').trim();
  const links = getLinks()
    .filter(l => String(l?.regnum||'').trim() === r)
    .slice()
    .sort((a,b) => String(a?.dateFrom||'').localeCompare(String(b?.dateFrom||'')));

  const result = [];
  links.forEach(l => {
    const df = parseISO(l.dateFrom);
    const dt = parseISO(l.dateTo) || null; // null = –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å
    if(!df) return;

    // –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å [from,to]
    const segFrom = from ? maxDate(df, from) : df;
    const segTo   = to ? minDate(dt || to, to) : dt;

    if(segTo && segFrom > segTo) return;
    if(!segTo && to && segFrom > to) return;

    result.push({
      abonentId: String(l.abonentId||'').trim(),
      from: segFrom,
      to: segTo, // –º–æ–∂–µ—Ç –±—ã—Ç—å null
      reason: '–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (links)'
    });
  });

  return result;
}

function renderHeader(regnum){
  const r = String(regnum||'').trim();
  const addr = resolveAddressByRegnum(r);

  q('hdr').textContent = r ? `–ö–≤–∞—Ä—Ç–∏—Ä–∞ (—Ä–µ–≥. ‚Ññ): ${r}` : '–ö–≤–∞—Ä—Ç–∏—Ä–∞ (—Ä–µ–≥. ‚Ññ): ‚Äî';

  // –∞–¥—Ä–µ—Å –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π ‚Äî —á—Ç–æ–±—ã –≤ —Å—É–¥–µ –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ
  q('hdrAddr').innerHTML = addr
    ? `<b>–ê–¥—Ä–µ—Å:</b> ${addr}`
    : `<b>–ê–¥—Ä–µ—Å:</b> ‚Äî (–∞–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω; –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ premises –∏–ª–∏ –∞–¥—Ä–µ—Å–Ω—ã—Ö –ø–æ–ª–µ–π –∞–±–æ–Ω–µ–Ω—Ç–∞)`;
}

function run(){
  const params = new URLSearchParams(location.search);
  const regnum = params.get('regnum') || '';
  const r = String(regnum).trim();
  if(!r){ alert('–ù–µ—Ç regnum'); return; }

  const from = parseISO(q('from').value);
  const to = parseISO(q('to').value);
  if(from && to && from > to){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–µ—Ä–∏–æ–¥: –¥–∞—Ç–∞ "—Å" –±–æ–ª—å—à–µ "–ø–æ"'); return; }

  renderHeader(r);

  const rows = q('rows');
  rows.innerHTML = '';
  const db = getDb();

  const segs = splitByPeriod(r, from, to);
  if(!segs.length){
    rows.innerHTML = `<tr><td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</td></tr>`;
    return;
  }

  segs.forEach(s => {
    const fio = String(db[s.abonentId]?.fio || '').trim();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtISO(s.from)} ‚Äî ${s.to ? fmtISO(s.to) : '–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è'}</td>
      <td>${s.abonentId}</td>
      <td>${fio || '‚Äî'}</td>
      <td>${s.reason}</td>
    `;
    rows.appendChild(tr);
  });
}

// –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –¥–∞—Ç—ã (—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)
(function init(){
  const params = new URLSearchParams(location.search);
  const regnum = params.get('regnum') || '';
  const r = String(regnum).trim();

  renderHeader(r);

  const now = new Date();
  const from = new Date(now.getFullYear(), now.getMonth(), 1);
  const to = new Date(now.getFullYear(), now.getMonth()+1, 0);
  q('from').value = fmtISO(from);
  q('to').value = fmtISO(to);

  if(r) run();
})();
</script>

<script>closeLayout();</script>
</body>
</html>
